<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Neuron OS</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>">
<!-- Firebase compat (–ø—Ä–æ—Å—Ç–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
/* ====== –°–¢–ò–õ–ò (–∏–∑ —Ç–≤–æ–µ–≥–æ style.css, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏) ====== */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
body { overflow: hidden; background: #000; color: #fff; height: 100vh; width: 100vw; }

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.5s ease; }
.login-window { background: rgba(30,30,40,0.9); border-radius: 20px; padding: 40px; width: 400px; max-width: 90vw; box-shadow: 0 20px 40px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(20px); animation: scaleIn 0.5s ease; }
.login-header { text-align: center; margin-bottom: 30px; }
.login-header h2 { font-size: 2.5rem; margin-bottom: 10px; background: linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.login-header p { color: #ccc; font-size: 1rem; }
.input-group { margin-bottom: 20px; }
.input-group label { display:block; margin-bottom:8px; color:#ccc; font-size:0.9rem; }
.input-group input { width:100%; padding:12px 16px; border:1px solid rgba(255,255,255,0.2); border-radius:10px; background: rgba(255,255,255,0.1); color:white; font-size:1rem; transition: all .3s; }
.input-group input:focus { outline:none; border-color:#4ecdc4; box-shadow: 0 0 0 2px rgba(78,205,196,0.2); }
.login-button { width:100%; padding:14px; background: linear-gradient(45deg,#4ecdc4,#45b7d1); border:none; border-radius:10px; color:white; font-size:1rem; font-weight:600; cursor:pointer; transition: all .3s; margin-bottom:15px; }
.login-button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(78,205,196,0.3); }
.google-login-button { width:100%; padding:14px; background: rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:10px; color:white; font-size:1rem; cursor:pointer; transition: all .3s; margin-bottom:20px; }
.register-link { text-align:center; color:#ccc; }
.register-link a { color:#4ecdc4; text-decoration:none; }
.register-link a:hover { text-decoration:underline; }
.demo-button { position:absolute; top:20px; right:20px; padding:12px 20px; background: linear-gradient(45deg,#4ecdc4,#45b7d1); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; box-shadow: 0 4px 15px rgba(78,205,196,0.3); z-index:1001; }

/* –†–∞–±–æ—á–∏–π —Å—Ç–æ–ª */
.desktop { position: relative; width: 100%; height: 100vh; display: none; }
.wallpaper { position:absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg,#0c0c0c 0%,#1a1a2e 50%,#16213e 100%); z-index:-1; background-size:cover; background-position:center; }

/* –ò–∫–æ–Ω–∫–∏ —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞ - 3 –ö–û–õ–û–ù–ö–ò –¥–ª—è –ü–ö */
.desktop-icons { 
    position:absolute; 
    top:20px; 
    left:20px; 
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    width: auto;
}
.desktop-icon { 
    display:flex; 
    flex-direction:column; 
    align-items:center; 
    width:80px; 
    padding:10px; 
    border-radius:10px; 
    cursor:pointer; 
    transition: all .3s; 
    user-select:none; 
}
.desktop-icon:hover { background: rgba(255,255,255,0.1); transform: scale(1.05); }
.desktop-icon .icon { font-size:2rem; margin-bottom:5px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
.desktop-icon span { font-size:0.8rem; text-align:center; color:white; text-shadow:0 1px 2px rgba(0,0,0,0.5); }

/* –û–∫–Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π */
.window { position:absolute; top:100px; left:100px; width:800px; height:600px; max-width:90vw; max-height:80vh; background: rgba(30,30,40,0.9); border-radius:15px; backdrop-filter: blur(20px); border:1px solid rgba(255,255,255,0.1); box-shadow:0 20px 40px rgba(0,0,0,0.3); overflow:hidden; animation: windowOpen .3s ease; z-index:10; display:flex; flex-direction:column; }
.window.minimized { display:none; }
.window.maximized { width:100% !important; height: calc(100% - 70px) !important; top:0 !important; left:0 !important; transform:none !important; border-radius:0; }
.window-header { display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background: rgba(0,0,0,0.3); border-bottom:1px solid rgba(255,255,255,0.1); cursor:move; user-select:none; }
.window-title { display:flex; align-items:center; gap:10px; font-weight:600; }
.window-controls { display:flex; gap:10px; }
.window-control { width:12px; height:12px; border-radius:50%; cursor:pointer; transition: all .2s; }
.window-control.close { background:#ff5f57; }
.window-control.minimize { background:#ffbd2e; }
.window-control.maximize { background:#28ca42; }
.window-control:hover { transform: scale(1.1); }
.window-content { height: calc(100% - 50px); overflow:auto; }
.window-content iframe { width:100%; height:100%; border:none; background:white; }

/* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é */
.context-menu { position: fixed; background: rgba(40,40,50,0.95); backdrop-filter: blur(20px); border:1px solid rgba(255,255,255,0.1); border-radius:10px; padding:8px 0; box-shadow:0 10px 30px rgba(0,0,0,0.3); z-index:100; display:none; min-width:200px; color:white; }
.context-item { padding:10px 20px; cursor:pointer; transition: background .2s; font-size:.9rem; }
.context-item:hover { background: rgba(255,255,255,0.1); }

/* –ü–∞–Ω–µ–ª—å –∑–∞–¥–∞—á (Dock) */
.dock { position: fixed; bottom:20px; left:50%; transform: translateX(-50%); background: rgba(40,40,50,0.7); backdrop-filter: blur(20px); border:1px solid rgba(255,255,255,0.1); border-radius:20px; padding:10px 20px; display:flex; align-items:center; gap:20px; z-index:100; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
.dock-items { display:flex; gap:5px; }
.dock-item { position:relative; padding:8px; border-radius:10px; cursor:pointer; transition: all .3s; }
.dock-item:hover { transform: translateY(-5px) scale(1.1); }
.dock-item.active .dock-icon { filter: brightness(1.2) drop-shadow(0 0 10px rgba(78,205,196,0.5)); }
.dock-icon { font-size:1.8rem; transition: all .3s; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
.active-indicator { position:absolute; bottom:-2px; left:50%; transform:translateX(-50%); width:6px; height:6px; background:white; border-radius:50%; }

/* –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–≤ –¥–æ–∫–µ) */
.system-info { display:flex; align-items:center; gap:15px; margin-left:20px; }
.clock { font-size:.9rem; font-weight:600; color:white; }

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä online/offline */
.network-indicator { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; vertical-align:middle; }
.network-online { background:#2ecc71; box-shadow:0 0 6px rgba(46,204,113,0.5); }
.network-offline { background:#e74c3c; box-shadow:0 0 6px rgba(231,76,60,0.4); }

/* –ú–µ–Ω—é "–ü—É—Å–∫" */
.start-menu { position: fixed; bottom:80px; left:50%; transform: translateX(-50%); width:500px; max-width:90vw; height:500px; max-height:60vh; background: rgba(40,40,50,0.9); backdrop-filter: blur(30px); border:1px solid rgba(255,255,255,0.1); border-radius:20px; padding:20px; box-shadow:0 20px 60px rgba(0,0,0,0.4); z-index:90; display:none; overflow:hidden; }

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
@keyframes scaleIn { from { opacity:0; transform:scale(0.8);} to { opacity:1; transform:scale(1);} }
@keyframes windowOpen { from { opacity:0; transform:scale(0.8);} to { opacity:1; transform:scale(1);} }

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 1024px) {
    .desktop-icons {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
}

@media (max-width: 768px) {
    .desktop-icons {
        grid-template-columns: repeat(1, 1fr);
        gap: 15px;
        top: 10px;
        left: 10px;
    }
    .desktop-icon { 
        width: 70px; 
    }
    .desktop-icon .icon { 
        font-size: 1.8rem; 
    }
    .desktop-icon span { 
        font-size: 0.75rem; 
    }
    .dock { 
        bottom: 10px; 
        padding: 8px 15px; 
    }
    .dock-icon { 
        font-size: 1.5rem; 
    }
    .window { 
        width: 95vw; 
        height: 70vh; 
    }
    .window-header { 
        padding: 10px 15px; 
    }
    .window-control { 
        width: 10px; 
        height: 10px; 
    }
}

/* –û –Ω–∞—Å —Å—Ç–∏–ª–∏ */
.about-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
.about-section h4 { margin-bottom: 15px; }
.social-icons { display: flex; gap: 15px; margin-bottom: 20px; }
.social-icon { font-size: 2rem; cursor: pointer; transition: transform 0.3s; }
.social-icon:hover { transform: scale(1.1); }
.support-button { padding: 10px 20px; background: linear-gradient(45deg,#4ecdc4,#45b7d1); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; transition: all .3s; }
.support-button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(78,205,196,0.3); }

/* –ú–æ–±–∏–ª—å–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ */
.mobile-drag-indicator {
    position: absolute;
    top: 5px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 4px;
    background: rgba(255,255,255,0.3);
    border-radius: 2px;
    display: none;
}
.window.mobile-dragging .mobile-drag-indicator {
    display: block;
}
</style>
</head>
<body>

<!-- ===== HTML: LOGIN MODAL ===== -->
<div id="login-modal" class="modal" aria-hidden="false">
    <button class="demo-button" onclick="activateDemoMode()">–î–µ–º–æ-—Ä–µ–∂–∏–º</button>
    <div class="login-window" role="dialog" aria-modal="true">
        <div class="login-header">
            <h2>Neuron OS</h2>
            <p>–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ—é —ç–∫–æ—Å–∏—Å—Ç–µ–º—É</p>
        </div>
        <div class="login-form">
            <div class="input-group">
                <label for="email">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</label>
                <input type="email" id="email" placeholder="your@email.com" value="">
            </div>
            <div class="input-group">
                <label for="password">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="">
            </div>
            <button id="login-btn" class="login-button" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
            <button id="google-login" class="google-login-button" onclick="handleGoogleLogin()">
                <span>–í–æ–π—Ç–∏ —Å –ø–æ–º–æ—â—å—é Google</span>
            </button>
            <p class="register-link">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="handleRegister();return false;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
        </div>
    </div>
</div>

<!-- ===== DESKTOP ===== -->
<div id="desktop" class="desktop" aria-hidden="true">
    <div class="wallpaper" id="wallpaper"></div>

    <!-- –ò–ö–û–ù–ö–ò –†–ê–ë–û–ß–ï–ì–û –°–¢–û–õ–ê –í 3 –ö–û–õ–û–ù–ö–ò -->
    <div class="desktop-icons" id="desktop-icons">
        <!-- –ü–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="desktop-icon" data-app="ai" onclick="openApp('ai')" oncontextmenu="return showContextMenu(event,'ai','desktop')">
            <div class="icon">üß†</div><span>Neuron AI</span>
        </div>
        <div class="desktop-icon" data-app="notes" onclick="openApp('notes')" oncontextmenu="return showContextMenu(event,'notes','desktop')">
            <div class="icon">üìù</div><span>Neuron Notes</span>
        </div>
        <div class="desktop-icon" data-app="converter" onclick="openApp('converter')" oncontextmenu="return showContextMenu(event,'converter','desktop')">
            <div class="icon">üîÑ</div><span>Neuron Converter</span>
        </div>
        
        <!-- –í—Ç–æ—Ä–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="desktop-icon" data-app="budget" onclick="openApp('budget')" oncontextmenu="return showContextMenu(event,'budget','desktop')">
            <div class="icon">üí∞</div><span>Neuron Budget</span>
        </div>
        <div class="desktop-icon" data-app="synapse" onclick="openApp('synapse')" oncontextmenu="return showContextMenu(event,'synapse','desktop')">
            <div class="icon">üåê</div><span>Synapse</span>
        </div>
        <div class="desktop-icon" data-app="study" onclick="openApp('study')" oncontextmenu="return showContextMenu(event,'study','desktop')">
            <div class="icon">üìö</div><span>Neuron Study</span>
        </div>
        
        <!-- –¢—Ä–µ—Ç—å—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="desktop-icon" data-app="password" onclick="openApp('password')" oncontextmenu="return showContextMenu(event,'password','desktop')">
            <div class="icon">üîê</div><span>Password Generator</span>
        </div>
        <div class="desktop-icon" data-app="tools" onclick="openApp('tools')" oncontextmenu="return showContextMenu(event,'tools','desktop')">
            <div class="icon">üß∞</div><span>Neuron Tools</span>
        </div>
        <div class="desktop-icon" data-app="games" onclick="openApp('games')" oncontextmenu="return showContextMenu(event,'games','desktop')">
            <div class="icon">üéÆ</div><span>Game Hub</span>
        </div>
        
        <!-- –ß–µ—Ç–≤–µ—Ä—Ç–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="desktop-icon" data-app="browser" onclick="openApp('browser')" oncontextmenu="return showContextMenu(event,'browser','desktop')">
            <div class="icon">üåê</div><span>–ò–Ω—Ç–µ—Ä–Ω–µ—Ç</span>
        </div>
        <div class="desktop-icon" data-app="settings" onclick="openApp('settings')" oncontextmenu="return showContextMenu(event,'settings','desktop')">
            <div class="icon">‚öôÔ∏è</div><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </div>
    </div>

    <div id="windows-container"></div>

    <div id="context-menu" class="context-menu" style="display:none;"></div>
</div>

<!-- ===== DOCK ===== -->
<div class="dock" id="dock">
    <div class="dock-items" id="dock-items">
        <div class="dock-item" data-app="browser" onclick="toggleAppWindow('browser')" oncontextmenu="return showContextMenu(event,'browser','dock')">
            <div class="dock-icon">üåê</div>
            <div class="active-indicator" style="display:none;"></div>
        </div>
    </div>
    <div class="system-info">
        <div id="network-status" title="–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏"><span class="network-indicator network-offline" id="network-dot"></span><span id="network-text">–û—Ñ—Ñ–ª–∞–π–Ω</span></div>
        <div id="clock" class="clock">00:00</div>
    </div>
</div>

<!-- Start menu (–ø—É—Å—Ç) -->
<div id="start-menu" class="start-menu">
    <div class="start-header">
        <h3>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
        <div class="search-box">
            <input type="text" id="app-search" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π..." oninput="filterApps()">
        </div>
    </div>
    <div class="app-grid" id="app-grid"></div>
</div>

<!-- ===== –°–ö–†–ò–ü–¢: –≤–µ—Å—å JS (–≤–∫–ª—é—á–∞—è Firebase) ===== -->
<script>
/* ====== –ö–æ–Ω—Ñ–∏–≥ Firebase (—Ç–æ—Ç, —á—Ç–æ —Ç—ã –¥–∞–ª) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDOaDVzzPjyYm4HWMND2XYWjLy_h4wty5s",
  authDomain: "neuron-ecosystem-2025.firebaseapp.com",
  projectId: "neuron-ecosystem-2025",
  storageBucket: "neuron-ecosystem-2025.firebasestorage.app",
  messagingSenderId: "589834476565",
  appId: "1:589834476565:web:622fe04057d33339dd421c",
  measurementId: "G-Z934BZPLG3"
};

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (compat) */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
const state = {
    currentUser: null,
    openWindows: {},
    pinnedApps: [],        // –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∏–∑ Firestore)
    transientDock: {},     // –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö (–Ω–µ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö) –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
    activeApp: null,
    isDemoMode: false,
    userDocUnsub: null,
    mobileDragMode: false  // —Ä–µ–∂–∏–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
};

/* –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
const apps = {
    'ai': { name: 'Neuron AI', icon: 'üß†', url: null, builtin: true },
    'notes': { name: 'Neuron Notes', icon: 'üìù', url: 'https://neuron-p2p.ru/notes.html' },
    'converter': { name: 'Neuron Converter', icon: 'üîÑ', url: 'https://neuron-ecosystem.github.io/Unit-Converter/' },
    'study': { name: 'Neuron Study', icon: 'üìö', url: 'https://neuron-ecosystem.github.io/Neuron-Study/' },
    'password': { name: 'Password Generator', icon: 'üîê', url: 'https://neuron-ecosystem.github.io/Password-Generator/' },
    'budget': { name: 'Neuron Budget', icon: 'üí∞', url: 'https://neuron-ecosystem.github.io/Neuron-Budget/' },
    'games': { name: 'Game Hub', icon: 'üéÆ', url: 'https://neuron-ecosystem.github.io/Game-Hub/' },
    'tools': { name: 'Neuron Tools', icon: 'üß∞', url: 'https://neuron-ecosystem.github.io/Neuron-Tools/' },
    'synapse': { name: 'Synapse', icon: 'üåê', url: 'https://neuron-ecosystem.github.io/Synapse/' },
    'browser': { name: '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç', icon: 'üåê', url: 'https://neuron-p2p.ru' },
    'settings': { name: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', icon: '‚öôÔ∏è', url: null, builtin: true }
};

/* localStorage keys */
const LS_USER_KEY = 'neuron_current_user';
const LS_DATA_KEY = 'neuron_user_data_backup';

/* DOM —ç–ª–µ–º–µ–Ω—Ç—ã */
const loginModal = document.getElementById('login-modal');
const desktop = document.getElementById('desktop');
const wallpaperEl = document.getElementById('wallpaper');
const dockItemsContainer = () => document.getElementById('dock-items');
const windowsContainer = () => document.getElementById('windows-container');
const contextMenuEl = document.getElementById('context-menu');
const networkDot = document.getElementById('network-dot');
const networkText = document.getElementById('network-text');

/* –¢–µ–∫—É—â–∏–µ –æ–±–æ–∏ */
let currentWallpaper = 'default';

/* ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ========== */
document.addEventListener('DOMContentLoaded', () => {
    initializeClock();
    initializeEventListeners();
    renderAppGrid();
    checkAuthStatus();
    updateNetworkIndicator();
});

/* ========== AUTH (email/password + Google + demo) ========== */

function checkAuthStatus() {
    // –ï—Å–ª–∏ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –∑–∞–ø–æ–º–Ω–∏–º –∏ –ø–æ–¥–æ–∂–¥—ë–º onAuthStateChanged
    const saved = localStorage.getItem(LS_USER_KEY);
    if (saved) {
        state.currentUser = JSON.parse(saved);
    }
    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤ Firebase
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª
            state.currentUser = { email: user.email, uid: user.uid };
            localStorage.setItem(LS_USER_KEY, JSON.stringify(state.currentUser));
            await afterLogin();
        } else {
            // –Ω–∏–∫—Ç–æ –Ω–µ –≤–æ—à—ë–ª
            // –µ—Å–ª–∏ —É –Ω–∞—Å –±—ã–ª –ª–æ–∫–∞–ª—å–Ω–æ –∑–∞–ø–æ–º–Ω–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä –¥–µ–º–æ), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            if (state.currentUser && state.isDemoMode) {
                await afterLogin();
            } else {
                showLoginModal();
            }
        }
    });
}

function activateDemoMode() {
    state.isDemoMode = true;
    state.currentUser = { email: 'demo@neuron.ru', uid: 'demo-user' };
    localStorage.setItem(LS_USER_KEY, JSON.stringify(state.currentUser));
    afterLogin();
}

async function handleLogin() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    if (!email || !password) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }
    try {
        const res = await auth.signInWithEmailAndPassword(email, password);
        state.currentUser = { email: res.user.email, uid: res.user.uid };
        localStorage.setItem(LS_USER_KEY, JSON.stringify(state.currentUser));
        // afterLogin –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –∏–∑ onAuthStateChanged
    } catch (err) {
        alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + err.message);
    }
}

async function handleGoogleLogin() {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
        const res = await auth.signInWithPopup(provider);
        state.currentUser = { email: res.user.email, uid: res.user.uid };
        localStorage.setItem(LS_USER_KEY, JSON.stringify(state.currentUser));
        // afterLogin –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –∏–∑ onAuthStateChanged
    } catch (err) {
        alert('–û—à–∏–±–∫–∞ Google –≤—Ö–æ–¥–∞: ' + err.message);
    }
}

async function handleRegister() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    if (!email || !password) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'); return; }
    try {
        const res = await auth.createUserWithEmailAndPassword(email, password);
        state.currentUser = { email: res.user.email, uid: res.user.uid };
        localStorage.setItem(LS_USER_KEY, JSON.stringify(state.currentUser));
        // —Å–æ–∑–¥–∞—ë–º –Ω–∞—á–∞–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await db.collection('users').doc(state.currentUser.uid).set({
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            wallpaper: 'default',
            pinnedApps: ['browser','settings']
        }, { merge: true });
        // afterLogin –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –∏–∑ onAuthStateChanged
    } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + err.message);
    }
}

async function handleLogout() {
    try {
        if (!state.isDemoMode) await auth.signOut();
    } catch (e) {
        console.warn('signOut error', e);
    }
    // –û—á–∏—Å—Ç–∏–º –ª–æ–∫–∞–ª—å–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ—Å—Ç–∞–≤–ª—è–µ–º –±—ç–∫–∞–ø –Ω–∞—Å—Ç—Ä–æ–µ–∫)
    localStorage.removeItem(LS_USER_KEY);
    state.currentUser = null;
    state.isDemoMode = false;
    // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç onSnapshot –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∞–Ω—ã
    if (state.userDocUnsub) {
        try { state.userDocUnsub(); } catch {}
        state.userDocUnsub = null;
    }
    // –°–∫—Ä—ã–≤–∞–µ–º —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª
    document.getElementById('desktop').style.display = 'none';
    showLoginModal();
}

/* –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞ ‚Äî —Å—Ç–∞—Ä—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏ –ø–æ–¥–ø–∏—Å–∫—É */
async function afterLogin() {
    hideLoginModal();
    await loadUserDataAndSubscribe();
    showDesktop();
    initializeDock();
}

/* ========== UI HELPERS ========== */
function showLoginModal() {
    loginModal.style.display = 'flex';
    document.getElementById('desktop').style.display = 'none';
    loginModal.setAttribute('aria-hidden','false');
    desktop.setAttribute('aria-hidden','true');
}
function hideLoginModal() {
    loginModal.style.display = 'none';
    loginModal.setAttribute('aria-hidden','true');
}
function showDesktop() {
    document.getElementById('desktop').style.display = 'block';
    document.getElementById('desktop').setAttribute('aria-hidden','false');
}

/* ========== Firestore + onSnapshot + –ª–æ–∫–∞–ª—å–Ω—ã–π –±—ç–∫–∞–ø ========== */

async function loadUserDataAndSubscribe() {
    if (!state.currentUser) return;
    const uid = state.currentUser.uid;
    const userRef = db.collection('users').doc(uid);

    // —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ (—á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—á.—Å–æ—Å—Ç–æ—è–Ω–∏–µ)
    try {
        const docSnap = await userRef.get();
        if (docSnap.exists) {
            const data = docSnap.data();
            applyUserDataLocally(data);
            // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ —Ä–µ–∑–µ—Ä–≤
            localStorage.setItem(LS_DATA_KEY, JSON.stringify(data));
        } else {
            // —Å–æ–∑–¥–∞—ë–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
            const defaultData = { wallpaper: 'default', pinnedApps: ['browser','settings'], updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
            await userRef.set(defaultData, { merge: true });
            applyUserDataLocally(defaultData);
            localStorage.setItem(LS_DATA_KEY, JSON.stringify(defaultData));
        }
    } catch (err) {
        console.warn('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∏–∑ Firestore, –ø—Ä–æ–±—É–µ–º localStorage', err);
        const backup = localStorage.getItem(LS_DATA_KEY);
        if (backup) {
            const data = JSON.parse(backup);
            applyUserDataLocally(data);
        }
    }

    // –ü–æ–¥–ø–∏—Å–∫–∞ onSnapshot ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
    if (state.userDocUnsub) {
        try { state.userDocUnsub(); } catch {}
        state.userDocUnsub = null;
    }
    try {
        state.userDocUnsub = userRef.onSnapshot(snapshot => {
            if (!snapshot.exists) return;
            const data = snapshot.data();
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö (–ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞)
            applyUserDataLocally(data);
            localStorage.setItem(LS_DATA_KEY, JSON.stringify(data));
        }, err => {
            console.warn('onSnapshot error', err);
        });
    } catch (e) {
        console.warn('subscribe failed', e);
    }
}

function applyUserDataLocally(data) {
    // –û–±–æ–∏
    if (data.wallpaper) {
        currentWallpaper = data.wallpaper;
        applyWallpaperFrom(currentWallpaper);
    }
    // pinned apps
    if (Array.isArray(data.pinnedApps)) {
        state.pinnedApps = data.pinnedApps;
        initializeDock();
    }
}

/* Save to Firestore + local fallback */
async function saveUserData() {
    const data = { pinnedApps: state.pinnedApps, wallpaper: currentWallpaper || 'default', updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
    localStorage.setItem(LS_DATA_KEY, JSON.stringify(data));
    if (!state.currentUser || state.isDemoMode) return;
    const uid = state.currentUser.uid;
    try {
        await db.collection('users').doc(uid).set(data, { merge: true });
    } catch (err) {
        console.warn('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ Firestore, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ', err);
    }
}

/* –ü—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ç–∏ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ */
async function syncLocalToCloudIfNeeded() {
    if (!navigator.onLine) return;
    if (!state.currentUser || state.isDemoMode) return;
    const uid = state.currentUser.uid;
    const userRef = db.collection('users').doc(uid);
    const local = localStorage.getItem(LS_DATA_KEY);
    if (!local) return;
    try {
        const parsed = JSON.parse(local);
        // –ú–µ—Ä–¥–∂–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ
        await userRef.set(parsed, { merge: true });
    } catch (e) {
        console.warn('syncLocalToCloud error', e);
    }
}

/* ========== DOCK / WINDOWS / CONTEXT MENU (–ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó) ========== */

function initializeDock() {
    // –æ—á–∏—Å—Ç–∏—Ç—å –¥–æ–∫ –∏ –∑–∞–Ω–æ–≤–æ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ
    const dock = dockItemsContainer();
    dock.innerHTML = '';
    // –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º browser —Å–ª–µ–≤–∞
    addDockItem('browser', state.pinnedApps.includes('browser') || true);
    // –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ pinned
    state.pinnedApps.forEach(appId => {
        if (appId !== 'browser') addDockItem(appId, true);
    });
    // –≤—Ä–µ–º–µ–Ω–Ω—ã–µ open –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    Object.keys(state.transientDock).forEach(appId => {
        if (!state.pinnedApps.includes(appId)) addDockItem(appId, false, true);
    });
}

/* –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –≤ –¥–æ–∫ */
function addDockItem(appId, pinned=false, transient=false) {
    if (document.querySelector('.dock-item[data-app="'+appId+'"]')) return;
    const app = apps[appId];
    if (!app) return;
    const el = document.createElement('div');
    el.className = 'dock-item';
    el.dataset.app = appId;
    if (pinned) el.dataset.pinned = '1';
    if (transient) el.dataset.transient = '1';
    el.onclick = () => toggleAppWindow(appId);
    el.oncontextmenu = (e) => { showContextMenu(e, appId, 'dock'); return false; };
    el.innerHTML = '<div class="dock-icon">'+app.icon+'</div><div class="active-indicator" style="display:none;"></div>';
    dockItemsContainer().appendChild(el);
}

/* –£–¥–∞–ª–∏—Ç—å dock-item (–µ—Å–ª–∏ transient) */
function removeDockItem(appId) {
    const node = document.querySelector('.dock-item[data-app="'+appId+'"]');
    if (!node) return;
    if (node.dataset.pinned === '1') return;
    node.remove();
}

/* –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî –Ω–µ –∑–∞–∫—Ä–µ–ø–ª—è—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ */
function openApp(appId) {
    const app = apps[appId];
    if (!app) return;
    // –µ—Å–ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ ‚Äî restore / front
    if (state.openWindows[appId]) {
        const win = state.openWindows[appId];
        if (win.classList.contains('minimized')) win.classList.remove('minimized');
        bringWindowToFront(appId);
        return;
    }
    // —Å–æ–∑–¥–∞—ë–º –æ–∫–Ω–æ
    const winEl = createAppWindow(appId);
    state.openWindows[appId] = winEl;
    // –µ—Å–ª–∏ –Ω–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ transient –∏–∫–æ–Ω–∫—É –≤ –¥–æ–∫
    if (!state.pinnedApps.includes(appId)) {
        state.transientDock[appId] = true;
        addDockItem(appId, false, true);
    }
    updateActiveApp(appId);
    saveUserData();
}

/* –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –æ–∫–Ω–æ (open/minimize) */
function toggleAppWindow(appId) {
    if (state.openWindows[appId]) {
        const win = state.openWindows[appId];
        if (win.classList.contains('minimized')) {
            win.classList.remove('minimized');
            bringWindowToFront(appId);
            updateActiveIndicator(appId, true);
        } else {
            // —Å–≤–µ—Ä–Ω—É—Ç—å –æ–∫–Ω–æ ‚Äî —Ç–æ—á–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è
            win.classList.add('minimized');
            updateActiveIndicator(appId, true); // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –≤–∏–¥–∏–º–æ–π
        }
    } else {
        openApp(appId);
    }
}

/* –°–æ–∑–¥–∞—Ç—å –æ–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
function createAppWindow(appId) {
    const app = apps[appId];
    const container = windowsContainer();
    const win = document.createElement('div');
    win.className = 'window';
    win.dataset.app = appId;

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    const mobileDragIndicator = '<div class="mobile-drag-indicator"></div>';

    const headerHtml = `
        <div class="window-header" onmousedown="startDrag(event,'${appId}')" ontouchstart="handleTouchStart(event,'${appId}')">
            <div class="window-title"><span>${app.icon}</span><span>${app.name}</span></div>
            <div class="window-controls">
                <div class="window-control minimize" title="–°–≤–µ—Ä–Ω—É—Ç—å" onclick="minimizeApp('${appId}')"></div>
                <div class="window-control maximize" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" onclick="maximizeApp('${appId}')"></div>
                <div class="window-control close" title="–ó–∞–∫—Ä—ã—Ç—å" onclick="closeApp('${appId}')"></div>
            </div>
        </div>
        ${mobileDragIndicator}
    `;
    const contentHtml = app.builtin ? `<div class="window-content">${getBuiltinAppContent(appId)}</div>` : `<div class="window-content"><iframe src="${app.url}" frameborder="0"></iframe></div>`;

    win.innerHTML = headerHtml + contentHtml;
    container.appendChild(win);

    // drag
    makeWindowDraggable(win);

    // init content
    if (appId === 'ai') initializeAIChat();
    if (appId === 'settings') initializeSettings();

    // –ø–æ–∫–∞–∑–∞—Ç—å –æ–∫–Ω–æ —Å—Ä–∞–∑—É
    win.style.display = 'flex';
    bringWindowToFront(appId);
    return win;
}

/* –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ */
function closeApp(appId) {
    if (state.openWindows[appId]) {
        state.openWindows[appId].remove();
        delete state.openWindows[appId];
    }
    if (state.transientDock[appId]) {
        delete state.transientDock[appId];
        removeDockItem(appId);
    }
    updateActiveApp(null);
}

/* –°–≤–µ—Ä–Ω—É—Ç—å */
function minimizeApp(appId) {
    if (!state.openWindows[appId]) return;
    state.openWindows[appId].classList.add('minimized');
    updateActiveIndicator(appId, true); // —Ç–æ—á–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è
}

/* –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å */
function maximizeApp(appId) {
    if (!state.openWindows[appId]) return;
    state.openWindows[appId].classList.toggle('maximized');
}

/* –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –Ω–∞ –ø–µ—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω */
function bringWindowToFront(appId) {
    if (!appId || !state.openWindows[appId]) return;
    Object.values(state.openWindows).forEach(w => w.style.zIndex = 10);
    state.openWindows[appId].style.zIndex = 20;
    updateActiveApp(appId);
}

/* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –≤ –¥–æ–∫–µ) */
function updateActiveApp(appId) {
    state.activeApp = appId;
    document.querySelectorAll('.dock-item').forEach(el => {
        const id = el.dataset.app;
        const ind = el.querySelector('.active-indicator');
        if (!ind) return;
        if (id === appId && state.openWindows[appId] && !state.openWindows[appId].classList.contains('minimized')) {
            ind.style.display = 'block';
        } else {
            ind.style.display = 'none';
        }
    });
}

/* –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
function updateActiveIndicator(appId, show) {
    const el = document.querySelector('.dock-item[data-app="'+appId+'"]');
    if (!el) return;
    const ind = el.querySelector('.active-indicator');
    if (ind) ind.style.display = show ? 'block' : 'none';
}

/* ========== –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ========== */

function showContextMenu(e, appId, origin='desktop') {
    e.preventDefault();
    e.stopPropagation();

    const isPinned = state.pinnedApps.includes(appId);
    const isDock = origin === 'dock';
    const items = [];

    if (isDock) {
        if (isPinned) items.push({ label: '–û—Ç–∫—Ä–µ–ø–∏—Ç—å –æ—Ç –ø–∞–Ω–µ–ª–∏ –∑–∞–¥–∞—á', action: 'unpin' });
        else items.push({ label: '–ó–∞–∫—Ä–µ–ø–∏—Ç—å –Ω–∞ –ø–∞–Ω–µ–ª–∏ –∑–∞–¥–∞—á', action: 'pin' });
        items.push({ label: '–û—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å', action: 'toggle' });
    } else {
        if (isPinned) items.push({ label: '–û—Ç–∫—Ä–µ–ø–∏—Ç—å –æ—Ç –ø–∞–Ω–µ–ª–∏ –∑–∞–¥–∞—á', action: 'unpin' });
        else items.push({ label: '–ó–∞–∫—Ä–µ–ø–∏—Ç—å –Ω–∞ –ø–∞–Ω–µ–ª–∏ –∑–∞–¥–∞—á', action: 'pin' });
        items.push({ label: '–û—Ç–∫—Ä—ã—Ç—å', action: 'open' });
        items.push({ label: '–û—Ç–∫—Ä—ã—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ', action: 'open-tab' });
        items.push({ label: '–°–ø—Ä–æ—Å–∏—Ç—å —É –ò–ò', action: 'ask-ai' });
    }

    if (appId === 'settings') items.push({ label: '–í—ã–π—Ç–∏', action: 'logout' });

    // render
    contextMenuEl.innerHTML = '';
    items.forEach(it => {
        const row = document.createElement('div');
        row.className = 'context-item';
        row.textContent = it.label;
        row.onclick = () => { handleContextMenuAction(it.action, appId); hideContextMenu(); };
        contextMenuEl.appendChild(row);
    });

    // –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ - –¥–ª—è –¥–æ–∫-–º–µ–Ω—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–¥ –ø–∞–Ω–µ–ª—å—é
    contextMenuEl.style.display = 'block';
    if (isDock) {
        const dockRect = document.getElementById('dock').getBoundingClientRect();
        contextMenuEl.style.left = e.pageX + 'px';
        contextMenuEl.style.top = (dockRect.top - contextMenuEl.offsetHeight - 10) + 'px';
    } else {
        contextMenuEl.style.left = e.pageX + 'px';
        contextMenuEl.style.top = e.pageY + 'px';
    }
    
    const cmRect = contextMenuEl.getBoundingClientRect();
    if (cmRect.right > window.innerWidth) contextMenuEl.style.left = (window.innerWidth - cmRect.width - 10) + 'px';
    if (cmRect.bottom > window.innerHeight) contextMenuEl.style.top = (window.innerHeight - cmRect.height - 10) + 'px';

    // –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
    setTimeout(() => { document.addEventListener('click', hideContextMenuOnce); }, 10);
    return false;
}

function hideContextMenuOnce() { hideContextMenu(); document.removeEventListener('click', hideContextMenuOnce); }
function hideContextMenu() { contextMenuEl.style.display = 'none'; }

function handleContextMenuAction(action, appId) {
    switch(action) {
        case 'pin':
            if (!state.pinnedApps.includes(appId)) {
                state.pinnedApps.push(appId);
                saveUserData();
                initializeDock();
            }
            break;
        case 'unpin':
            state.pinnedApps = state.pinnedApps.filter(x=>x!==appId);
            saveUserData();
            initializeDock();
            break;
        case 'open':
            openApp(appId); break;
        case 'open-tab':
            if (apps[appId] && apps[appId].url) window.open(apps[appId].url, '_blank');
            break;
        case 'ask-ai':
            openApp('ai');
            setTimeout(()=>{ 
                const aiInput = document.getElementById('ai-input'); 
                if(aiInput){ 
                    aiInput.value = `–†–∞—Å—Å–∫–∞–∂–∏ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ ${apps[appId].name}`; 
                    document.getElementById('ai-send')?.click(); 
                } 
            }, 500);
            break;
        case 'toggle':
            toggleAppWindow(appId); break;
        case 'logout':
            handleLogout(); break;
    }
}

/* ========== –û–±–æ–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ========== */

function applyWallpaperFrom(typeOrUrl) {
    if (!typeOrUrl) typeOrUrl = 'default';
    currentWallpaper = typeOrUrl;
    if (typeOrUrl === 'default') {
        wallpaperEl.style.backgroundImage = 'none';
        wallpaperEl.style.background = 'linear-gradient(135deg,#0c0c0c 0%,#1a1a2e 50%,#16213e 100%)';
    } else if (typeOrUrl.startsWith('data:') || typeOrUrl.startsWith('http')) {
        wallpaperEl.style.backgroundImage = `url(${typeOrUrl})`;
        wallpaperEl.style.backgroundSize = 'cover';
        wallpaperEl.style.backgroundPosition = 'center';
    } else if (typeOrUrl === 'space') {
        wallpaperEl.style.backgroundImage = 'none';
        wallpaperEl.style.background = 'linear-gradient(135deg,#000428 0%,#004e92 100%)';
    } else if (typeOrUrl === 'nature') {
        wallpaperEl.style.backgroundImage = 'none';
        wallpaperEl.style.background = 'linear-gradient(135deg,#134E5E 0%,#71B280 100%)';
    } else if (typeOrUrl === 'city') {
        wallpaperEl.style.backgroundImage = 'none';
        wallpaperEl.style.background = 'linear-gradient(135deg,#2C3E50 0%,#4CA1AF 100%)';
    } else {
        wallpaperEl.style.backgroundImage = 'none';
        wallpaperEl.style.background = 'linear-gradient(135deg,#0c0c0c 0%,#1a1a2e 50%,#16213e 100%)';
    }
}

/* initializeSettings ‚Äî —Å–æ–∑–¥–∞–µ—Ç UI –≤–Ω—É—Ç—Ä–∏ –æ–∫–Ω–∞ settings (–≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏) */
function initializeSettings() {
    const settingsWindow = document.querySelector('.window[data-app="settings"] .window-content');
    if (!settingsWindow) return;
    if (settingsWindow.querySelector('#logout-btn')) return; // —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ

    const html = `
        <div style="padding:20px;height:100%;overflow:auto;">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h3>
            <div style="margin-top:15px;">
                <h4>–û–±–æ–∏</h4>
                <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
                    <div class="wallpaper-preview btn-wallpaper" data-wallpaper="default" style="width:120px;height:80px;border-radius:10px;background:linear-gradient(135deg,#0c0c0c 0%,#1a1a2e 50%,#16213e 100%);cursor:pointer;border:2px solid transparent;">&nbsp;</div>
                    <div class="wallpaper-preview btn-wallpaper" data-wallpaper="space" style="width:120px;height:80px;border-radius:10px;background:linear-gradient(135deg,#000428 0%,#004e92 100%);cursor:pointer;border:2px solid transparent;">&nbsp;</div>
                    <div class="wallpaper-preview btn-wallpaper" data-wallpaper="nature" style="width:120px;height:80px;border-radius:10px;background:linear-gradient(135deg,#134E5E 0%,#71B280 100%);cursor:pointer;border:2px solid transparent;">&nbsp;</div>
                    <div class="wallpaper-preview btn-wallpaper" data-wallpaper="city" style="width:120px;height:80px;border-radius:10px;background:linear-gradient(135deg,#2C3E50 0%,#4CA1AF 100%);cursor:pointer;border:2px solid transparent;">&nbsp;</div>
                </div>
                <input type="file" id="wallpaper-upload" accept="image/*" style="margin-bottom:10px;">
                <div style="display:flex;gap:10px;margin-top:10px;">
                    <button id="apply-wallpaper" style="padding:8px 12px;border-radius:8px;background:#4ecdc4;border:none;cursor:pointer;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ–±–æ–∏</button>
                    <button id="logout-btn" style="padding:8px 12px;border-radius:8px;background:#ff5f57;border:none;cursor:pointer;color:#fff;">–í—ã–π—Ç–∏</button>
                </div>
            </div>
            <div class="about-section">
                <h4>–û –Ω–∞—Å</h4>
                <div class="social-icons">
                    <div class="social-icon" onclick="window.open('https://t.me/neuron_ecosystem', '_blank')">üì±</div>
                    <div class="social-icon" onclick="window.open('https://neuron-p2p.ru', '_blank')">üåê</div>
                    <div class="social-icon" onclick="window.open('https://vk.ru/club233118101', '_blank')">üë•</div>
                </div>
                <button class="support-button" onclick="window.open('https://yoomoney.ru/to/4100119394883694', '_blank')">–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
            </div>
        </div>
    `;
    settingsWindow.innerHTML = html;

    settingsWindow.querySelectorAll('.btn-wallpaper').forEach(el => {
        el.onclick = () => {
            settingsWindow.querySelectorAll('.btn-wallpaper').forEach(p => p.style.border = '2px solid transparent');
            el.style.border = '3px solid rgba(78,205,196,0.5)';
            settingsWindow.dataset.selectedWallpaper = el.dataset.wallpaper;
        };
    });

    settingsWindow.querySelector('#wallpaper-upload').addEventListener('change', (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const dataUrl = ev.target.result;
            settingsWindow.dataset.uploadedWallpaper = dataUrl;
            alert('–û–±–æ–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –ø–∞–º—è—Ç—å. –ù–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ–±–æ–∏¬ª.');
        };
        reader.readAsDataURL(f);
    });

    settingsWindow.querySelector('#apply-wallpaper').onclick = async () => {
        const uploaded = settingsWindow.dataset.uploadedWallpaper;
        const selectedPreset = settingsWindow.dataset.selectedWallpaper;
        if (uploaded) {
            currentWallpaper = uploaded;
            applyWallpaperFrom(uploaded);
        } else if (selectedPreset) {
            currentWallpaper = selectedPreset;
            applyWallpaperFrom(selectedPreset);
        } else {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ–∏ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª.');
            return;
        }
        await saveUserData();
        alert('–û–±–æ–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
    };

    settingsWindow.querySelector('#logout-btn').onclick = () => { handleLogout(); };
}

/* ========== –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (AI –∏ —Ç.–¥.) ========== */

function getBuiltinAppContent(appId) {
    switch(appId) {
        case 'ai':
            return `
                <div style="padding:20px;height:100%;display:flex;flex-direction:column;">
                    <div id="ai-chat" style="flex:1;overflow-y:auto;margin-bottom:10px;padding:10px;background:rgba(0,0,0,0.2);border-radius:10px;">
                        <div class="ai-message"><strong>Neuron AI:</strong> –ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à AI-–ø–æ–º–æ—â–Ω–∏–∫. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
                    </div>
                    <div style="display:flex;gap:10px;">
                        <input id="ai-input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É..." style="flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);color:white;">
                        <button id="ai-send" style="padding:10px 14px;border-radius:8px;background:#4ecdc4;border:none;cursor:pointer;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            `;
        case 'settings':
            return `<div style="padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</div>`;
        default:
            return `<div style="padding:20px;text-align:center;">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</div>`;
    }
}

/* ========== –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –æ–∫–æ–Ω ========== */
function makeWindowDraggable(win) {
    const header = win.querySelector('.window-header');
    if (!header) return;
    
    let isDragging = false, offsetX = 0, offsetY = 0;
    let touchStartTime = 0;
    let lastTouchTime = 0;
    let touchCount = 0;
    
    // Mouse events
    header.addEventListener('mousedown', (e) => {
        isDragging = true;
        offsetX = e.clientX - win.offsetLeft;
        offsetY = e.clientY - win.offsetTop;
        bringWindowToFront(win.dataset.app);
        e.preventDefault();
    });
    
    // Touch events for mobile - –¥–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    header.addEventListener('touchstart', (e) => {
        const now = Date.now();
        touchCount++;
        
        if (now - lastTouchTime < 300 && touchCount === 2) {
            // –î–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            isDragging = true;
            state.mobileDragMode = true;
            const touch = e.touches[0];
            offsetX = touch.clientX - win.offsetLeft;
            offsetY = touch.clientY - win.offsetTop;
            bringWindowToFront(win.dataset.app);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            win.classList.add('mobile-dragging');
            touchCount = 0;
        } else {
            // –û–¥–∏–Ω–æ—á–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ
            touchStartTime = now;
            const touch = e.touches[0];
            offsetX = touch.clientX - win.offsetLeft;
            offsetY = touch.clientY - win.offsetTop;
            bringWindowToFront(win.dataset.app);
        }
        
        lastTouchTime = now;
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(() => {
            touchCount = 0;
        }, 1000);
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const x = e.clientX - offsetX;
        const y = e.clientY - offsetY;
        const maxX = window.innerWidth - win.offsetWidth;
        const maxY = window.innerHeight - win.offsetHeight - 70;
        win.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
        win.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
    });
    
    document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const touch = e.touches[0];
        const x = touch.clientX - offsetX;
        const y = touch.clientY - offsetY;
        const maxX = window.innerWidth - win.offsetWidth;
        const maxY = window.innerHeight - win.offsetHeight - 70;
        win.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
        win.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
        e.preventDefault();
    });
    
    document.addEventListener('mouseup', () => {
        isDragging = false;
        state.mobileDragMode = false;
        win.classList.remove('mobile-dragging');
    });
    
    document.addEventListener('touchend', () => {
        isDragging = false;
        state.mobileDragMode = false;
        win.classList.remove('mobile-dragging');
    });
}

function handleTouchStart(e, appId) {
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å inline handlers
    bringWindowToFront(appId);
}

function startDrag(e, appId) {
    // This function is kept for compatibility with inline handlers
    bringWindowToFront(appId);
}

/* ========== –ß–∞—Ç –ò–ò (–ø—Ä–æ—Å—Ç–∞—è —ç–º—É–ª—è—Ü–∏—è) ========== */
function initializeAIChat() {
    const sendBtn = document.getElementById('ai-send');
    const input = document.getElementById('ai-input');
    if (!sendBtn || !input) return;
    const sendMessage = () => {
        const message = input.value.trim();
        if (!message) return;
        addAIMessage('user', message);
        input.value = '';
        setTimeout(() => {
            const response = generateAIResponse(message);
            addAIMessage('ai', response);
        }, 500);
    };
    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
}
function addAIMessage(sender, text) {
    const chat = document.getElementById('ai-chat');
    if (!chat) return;
    const div = document.createElement('div');
    div.className = 'ai-message';
    div.style.marginBottom = '10px';
    div.style.padding = '8px';
    div.style.borderRadius = '8px';
    div.style.background = sender === 'user' ? 'rgba(78,205,196,0.18)' : 'rgba(255,255,255,0.06)';
    div.innerHTML = `<strong>${sender === 'user' ? '–í—ã' : 'Neuron AI'}:</strong> ${text}`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}
function generateAIResponse(message) {
    const m = message.toLowerCase();
    if (m.includes('–ø—Ä–∏–≤–µ—Ç')) return '–ü—Ä–∏–≤–µ—Ç! –ß–µ–º –ø–æ–º–æ—á—å?';
    if (m.includes('/help')) return '–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: /open notes, /about –∏ —Ç.–¥.';
    if (m.includes('/about')) return 'Neuron OS ‚Äî –¥–µ–º–æ –≤–µ—Ä—Å–∏—è.';
    if (m.includes('synapse')) return 'Synapse ‚Äî —ç—Ç–æ –≤–µ–±-–±—Ä–∞—É–∑–µ—Ä —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏.';
    if (m.includes('study')) return 'Neuron Study ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —É—á–µ–±–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ –∑–∞–º–µ—Ç–æ–∫.';
    if (m.includes('password')) return 'Password Generator ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π.';
    if (m.includes('tools')) return 'Neuron Tools ‚Äî –Ω–∞–±–æ—Ä –ø–æ–ª–µ–∑–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞—á.';
    if (m.includes('notes')) return 'Neuron Notes ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∞–º–∏.';
    if (m.includes('converter')) return 'Neuron Converter ‚Äî –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è.';
    if (m.includes('budget')) return 'Neuron Budget ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏—á–Ω—ã–º–∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏.';
    if (m.includes('games')) return 'Game Hub ‚Äî –∫–æ–ª–ª–µ–∫—Ü–∏—è –º–∏–Ω–∏-–∏–≥—Ä –¥–ª—è —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è.';
    if (m.includes('browser')) return '–ë—Ä–∞—É–∑–µ—Ä ‚Äî –≤–µ–±-–æ–±–æ–∑—Ä–µ–≤–∞—Ç–µ–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–∞–π—Ç–æ–≤.';
    return '–ü–æ–∫–∞ –Ω–µ –∑–Ω–∞—é, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ.';
}

/* ========== –ß–∞—Å—ã, –ø–æ–∏—Å–∫, render grid ========== */

function initializeClock() {
    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('ru-RU',{ hour:'2-digit', minute:'2-digit' });
        document.getElementById('clock').textContent = timeString;
    }
    updateClock();
    setInterval(updateClock, 1000);
}

function renderAppGrid() {
    const grid = document.getElementById('app-grid');
    if (!grid) return;
    grid.innerHTML = '';
    Object.keys(apps).forEach(id => {
        const app = apps[id];
        const div = document.createElement('div');
        div.className = 'app-item';
        div.dataset.app = id;
        div.onclick = () => openApp(id);
        div.innerHTML = `<div class="app-icon">${app.icon}</div><span>${app.name}</span>`;
        grid.appendChild(div);
    });
}

function filterApps() {
    const search = document.getElementById('app-search').value.toLowerCase();
    document.querySelectorAll('.app-item').forEach(item => {
        const name = item.querySelector('span').textContent.toLowerCase();
        item.style.display = name.includes(search) ? 'flex' : 'none';
    });
}

/* ========== –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π UI ========== */

function initializeEventListeners() {
    // desktop icons contextmenu already bound inline; also add global
    document.querySelectorAll('.desktop-icon').forEach(icon => {
        icon.addEventListener('contextmenu', (e) => { showContextMenu(e, icon.dataset.app, 'desktop'); });
    });

    // global click closes context menu
    document.addEventListener('click', () => hideContextMenu());

    // prevent default right-click from showing browser menu when clicking on our icons/dock
    document.addEventListener('contextmenu', (e) => {
        const el = e.target.closest('.desktop-icon, .dock-item');
        if (!el) {
            // allow native context elsewhere
            return true;
        } else {
            e.preventDefault();
            return false;
        }
    });

    // network events
    window.addEventListener('online', () => { updateNetworkIndicator(); syncLocalToCloudIfNeeded(); });
    window.addEventListener('offline', () => { updateNetworkIndicator(); });
}

/* ========== Network indicator ========== */

function updateNetworkIndicator() {
    const online = navigator.onLine;
    if (online) {
        networkDot.classList.remove('network-offline'); networkDot.classList.add('network-online');
        networkText.textContent = '–û–Ω–ª–∞–π–Ω';
        // –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ‚Äî –ø—Ä–æ–±—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
        syncLocalToCloudIfNeeded();
    } else {
        networkDot.classList.remove('network-online'); networkDot.classList.add('network-offline');
        networkText.textContent = '–û—Ñ—Ñ–ª–∞–π–Ω';
    }
}

/* ========== load user data fallback (local) ========== */

async function loadUserData() {
    if (!state.currentUser) return;
    const uid = state.currentUser.uid;
    try {
        const doc = await db.collection('users').doc(uid).get();
        if (doc.exists) {
            const data = doc.data();
            applyUserDataLocally(data);
            localStorage.setItem(LS_DATA_KEY, JSON.stringify(data));
        } else {
            const defaultData = { wallpaper: 'default', pinnedApps: ['browser','settings'] };
            await db.collection('users').doc(uid).set(defaultData, { merge: true });
            applyUserDataLocally(defaultData);
            localStorage.setItem(LS_DATA_KEY, JSON.stringify(defaultData));
        }
    } catch (err) {
        console.warn('loadUserData error', err);
        const backup = localStorage.getItem(LS_DATA_KEY);
        if (backup) {
            const data = JSON.parse(backup);
            applyUserDataLocally(data);
        } else {
            applyUserDataLocally({ wallpaper: 'default', pinnedApps: ['browser','settings'] });
        }
    }
}

/* applyUserDataLocally used above and in subscription */
function applyUserDataLocally(data) {
    if (data.wallpaper) { currentWallpaper = data.wallpaper; applyWallpaperFrom(currentWallpaper); }
    if (Array.isArray(data.pinnedApps)) { state.pinnedApps = data.pinnedApps; initializeDock(); }
}

/* ========== –ü–æ–¥–ø–∏—Å–∫–∞ (onSnapshot) + –ª–æ–≥–∏–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ ========== */

async function loadUserDataAndSubscribe() {
    // –∏—Å–ø–æ–ª—å–∑—É–π—Å—è –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞
    if (!state.currentUser) return;
    const uid = state.currentUser.uid;
    const userRef = db.collection('users').doc(uid);

    // initial load
    try {
        const doc = await userRef.get();
        if (doc.exists) {
            const data = doc.data();
            applyUserDataLocally(data);
            localStorage.setItem(LS_DATA_KEY, JSON.stringify(data));
        } else {
            const defaultData = { wallpaper: 'default', pinnedApps: ['browser','settings'] };
            await userRef.set(defaultData, { merge: true });
            applyUserDataLocally(defaultData);
            localStorage.setItem(LS_DATA_KEY, JSON.stringify(defaultData));
        }
    } catch (e) {
        console.warn('Initial load failed', e);
        const backup = localStorage.getItem(LS_DATA_KEY);
        if (backup) applyUserDataLocally(JSON.parse(backup));
    }

    // subscribe for realtime
    if (state.userDocUnsub) {
        try { state.userDocUnsub(); } catch {}
        state.userDocUnsub = null;
    }
    try {
        state.userDocUnsub = userRef.onSnapshot(snapshot => {
            if (!snapshot.exists) return;
            const data = snapshot.data();
            applyUserDataLocally(data);
            localStorage.setItem(LS_DATA_KEY, JSON.stringify(data));
        }, err => {
            console.warn('onSnapshot error', err);
        });
    } catch (err) {
        console.warn('subscribe error', err);
    }
}

/* ========== sync local -> cloud if online ========== */

async function syncLocalToCloudIfNeeded() {
    if (!navigator.onLine) return;
    if (!state.currentUser || state.isDemoMode) return;
    const uid = state.currentUser.uid;
    const local = localStorage.getItem(LS_DATA_KEY);
    if (!local) return;
    try {
        const data = JSON.parse(local);
        await db.collection('users').doc(uid).set(data, { merge: true });
    } catch (e) {
        console.warn('sync error', e);
    }
}

/* ========== Misc helpers (context, etc.) ========== */

// click outside context menu closes it
document.addEventListener('click', hideContextMenu);

// expose some functions globally used in HTML inline handlers
window.handleLogin = handleLogin;
window.handleRegister = handleRegister;
window.handleGoogleLogin = handleGoogleLogin;
window.activateDemoMode = activateDemoMode;
window.openApp = openApp;
window.toggleAppWindow = toggleAppWindow;
window.handleLogout = handleLogout;
window.applyWallpaperFrom = applyWallpaperFrom;
window.handleTouchStart = handleTouchStart;

/* ========== keyboard shortcuts for dev/testing (optional) ==========
document.addEventListener('keydown', (e) => {
    if (e.key === 'F1') openApp('ai');
});
================================= */
</script>
</body>
</html>
