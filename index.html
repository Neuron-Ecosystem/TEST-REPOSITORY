<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>True Talk</title>
<style>
  /* --- –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ --- */
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background-color: #121212;
    color: #fff;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background-color: #1f1f1f;
  }
  header h1 {
    margin: 0;
    font-size: 1.5rem;
  }
  button {
    cursor: pointer;
  }
  main {
    padding: 10px 20px;
  }
  #post-form {
    display: flex;
    flex-direction: column;
    margin-bottom: 20px;
  }
  #post-input {
    padding: 10px;
    font-size: 1rem;
    border-radius: 5px;
    border: none;
    resize: none;
    margin-bottom: 5px;
  }
  #post-button {
    padding: 10px;
    font-size: 1rem;
    border-radius: 5px;
    border: none;
    background-color: #6200ee;
    color: #fff;
    transition: 0.2s;
  }
  #post-button:hover {
    background-color: #3700b3;
  }
  .post {
    background-color: #1f1f1f;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
    animation: fadeIn 0.3s ease;
  }
  .post .nick {
    font-weight: bold;
    margin-bottom: 5px;
  }
  .post .text {
    margin-bottom: 5px;
  }
  .post .actions {
    display: flex;
    gap: 10px;
  }
  .comment-section {
    margin-top: 5px;
  }
  .comment {
    margin-left: 10px;
    font-size: 0.9rem;
    margin-bottom: 2px;
  }
  #profile {
    margin-bottom: 20px;
  }
  #profile input {
    margin-right: 5px;
    padding: 5px;
    border-radius: 5px;
    border: none;
  }

  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity:1;}
  }

  @media(max-width: 600px){
    header h1 {font-size:1.2rem;}
    #post-input {font-size:0.9rem;}
    #post-button {font-size:0.9rem;}
  }
</style>
</head>
<body>
<header>
  <h1>True Talk</h1>
  <div>
    <button id="logout-btn" style="display:none;">–í—ã–π—Ç–∏</button>
  </div>
</header>
<main>
  <div id="auth-section">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button id="login-btn">–í–æ–π—Ç–∏ / –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <button id="google-btn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
  </div>

  <div id="profile" style="display:none;">
    –ù–∏–∫: <input type="text" id="nick-input" placeholder="–í–∞—à –Ω–∏–∫">
    –¶–≤–µ—Ç –Ω–∏–∫–∞: <input type="color" id="color-input" value="#ff0000">
    <button id="save-profile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>

  <form id="post-form" style="display:none;">
    <textarea id="post-input" rows="3" placeholder="–ß—Ç–æ —É —Ç–µ–±—è –Ω–∞ —É–º–µ? (–º–∞–∫—Å 280 —Å–∏–º–≤–æ–ª–æ–≤)"></textarea>
    <button type="submit" id="post-button">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    <small id="timeout-msg" style="color:#ff5555;"></small>
  </form>

  <div>
    –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:
    <select id="sort-select">
      <option value="new">–ù–æ–≤—ã–µ</option>
      <option value="old">–°—Ç–∞—Ä—ã–µ</option>
      <option value="popular">–°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
      <option value="less-popular">–ú–µ–Ω–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
    </select>
  </div>

  <div id="posts"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, getDocs, onSnapshot, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDOaDVzzPjyYm4HWMND2XYWjLy_h4wty5s",
  authDomain: "neuron-ecosystem-2025.firebaseapp.com",
  projectId: "neuron-ecosystem-2025",
  storageBucket: "neuron-ecosystem-2025.firebasestorage.app",
  messagingSenderId: "589834476565",
  appId: "1:589834476565:web:f657c13be1cbf8f3dd421c",
  measurementId: "G-G4NKXZX1ZX"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

let lastPostTime = 0;
let currentUser = null;

const loginBtn = document.getElementById("login-btn");
const googleBtn = document.getElementById("google-btn");
const logoutBtn = document.getElementById("logout-btn");
const authSection = document.getElementById("auth-section");
const postForm = document.getElementById("post-form");
const postInput = document.getElementById("post-input");
const postsDiv = document.getElementById("posts");
const nickInput = document.getElementById("nick-input");
const colorInput = document.getElementById("color-input");
const saveProfileBtn = document.getElementById("save-profile");
const profileDiv = document.getElementById("profile");
const timeoutMsg = document.getElementById("timeout-msg");
const sortSelect = document.getElementById("sort-select");

function renderPost(postData, postId) {
  const postEl = document.createElement("div");
  postEl.classList.add("post");
  postEl.id = postId;

  const nickEl = document.createElement("div");
  nickEl.classList.add("nick");
  nickEl.textContent = postData.nick;
  nickEl.style.color = postData.color;

  const textEl = document.createElement("div");
  textEl.classList.add("text");
  textEl.textContent = postData.text;

  const actionsEl = document.createElement("div");
  actionsEl.classList.add("actions");

  const likeBtn = document.createElement("button");
  likeBtn.textContent = `üëç ${postData.likes || 0}`;
  likeBtn.onclick = async () => {
    const postRef = doc(db, "posts", postId);
    await updateDoc(postRef, { likes: increment(1) });
  };

  const commentBtn = document.createElement("button");
  commentBtn.textContent = `üí¨ ${postData.comments ? postData.comments.length : 0}`;
  commentBtn.onclick = () => {
    const commentText = prompt("–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:");
    if (commentText) {
      addDoc(collection(db, "comments"), { postId, userId: currentUser.uid, text: commentText, created_at: new Date(), nick: nickInput.value, color: colorInput.value });
    }
  };

  actionsEl.appendChild(likeBtn);
  actionsEl.appendChild(commentBtn);

  postEl.appendChild(nickEl);
  postEl.appendChild(textEl);
  postEl.appendChild(actionsEl);

  postsDiv.appendChild(postEl);
}

async function loadPosts() {
  postsDiv.innerHTML = "";
  const postsCollection = collection(db, "posts");
  let q;
  const sortValue = sortSelect.value;
  if(sortValue==="new"){
    q = query(postsCollection, orderBy("created_at","desc"));
  } else if(sortValue==="old"){
    q = query(postsCollection, orderBy("created_at","asc"));
  } else if(sortValue==="popular"){
    q = query(postsCollection, orderBy("likes","desc"));
  } else if(sortValue==="less-popular"){
    q = query(postsCollection, orderBy("likes","asc"));
  } else{
    q = query(postsCollection, orderBy("created_at","desc"));
  }

  onSnapshot(q, async (snapshot)=>{
    postsDiv.innerHTML="";
    for(const docSnap of snapshot.docs){
      const postData = docSnap.data();
      const commentsSnapshot = await getDocs(collection(db,"comments"));
      postData.comments = commentsSnapshot.docs.filter(c=>c.data().postId===docSnap.id).map(c=>c.data());
      renderPost(postData, docSnap.id);
    }
  });
}

sortSelect.onchange = loadPosts;

loginBtn.onclick = async ()=>{
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try{
    await signInWithEmailAndPassword(auth,email,password);
  }catch(e){
    await createUserWithEmailAndPassword(auth,email,password);
  }
};

googleBtn.onclick = async ()=>{
  const provider = new GoogleAuthProvider();
  await signInWithPopup(auth,provider);
};

logoutBtn.onclick = async ()=>{
  await signOut(auth);
};

saveProfileBtn.onclick=async()=>{
  if(currentUser){
    await updateDoc(doc(db,"users",currentUser.uid),{nick:nickInput.value,color:colorInput.value});
  }
};

postForm.onsubmit=async(e)=>{
  e.preventDefault();
  if(Date.now()-lastPostTime<30000){
    timeoutMsg.textContent="–ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –ø–æ—Å—Ç–æ–º";
    return;
  }
  timeoutMsg.textContent="";
  if(postInput.value.length===0||postInput.value.length>280){
    alert("–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 280 —Å–∏–º–≤–æ–ª–æ–≤");
    return;
  }
  await addDoc(collection(db,"posts"),{
    userId: currentUser.uid,
    text: postInput.value,
    created_at: new Date(),
    nick: nickInput.value,
    color: colorInput.value,
    likes:0
  });
  postInput.value="";
  lastPostTime=Date.now();
};

onAuthStateChanged(auth,(user)=>{
  if(user){
    currentUser=user;
    authSection.style.display="none";
    postForm.style.display="block";
    profileDiv.style.display="block";
    logoutBtn.style.display="inline-block";
    nickInput.value=user.displayName||"–ê–Ω–æ–Ω–∏–º";
    loadPosts();
  }else{
    currentUser=null;
    authSection.style.display="block";
    postForm.style.display="none";
    profileDiv.style.display="none";
    logoutBtn.style.display="none";
  }
});
</script>
</body>
</html>
