<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>True Talk X ‚Äî Full Twitter-like MVP</title>
<style>
:root{--bg:#0b0c10;--card:#151922;--text:#e6edf3;--muted:#9aa3ad;--accent:#1d9bf0}
body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--text)}
header{padding:12px 16px;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center}
.logo{font-weight:900;font-size:20px}
button{background:var(--accent);border:none;border-radius:20px;padding:6px 14px;color:#fff;cursor:pointer}
button.outline{background:none;border:1px solid #333}
main{max-width:720px;margin:auto}
.composer{display:flex;gap:10px;padding:10px;border-bottom:1px solid #222}
.avatar{width:44px;height:44px;border-radius:999px;background:#555;display:flex;align-items:center;justify-content:center;font-weight:800}
textarea{flex:1;resize:none;background:none;color:white;border:none;font-size:16px;outline:none}
.post{border-bottom:1px solid #222;padding:10px;display:flex;gap:10px}
.post-body{flex:1}
.nick{font-weight:700}
.small{color:var(--muted);font-size:12px}
.actions{display:flex;gap:16px;margin-top:6px}
.reply-box{margin-top:8px;display:flex;gap:6px}
.reply-box textarea{font-size:14px}
.reply{margin-left:40px;border-left:2px solid #222;padding-left:8px;margin-top:8px}
.like{cursor:pointer;color:var(--muted)}
.like.active{color:#e11d48}
@media(max-width:600px){main{padding:0 6px}}
</style>
</head>
<body>
<header>
<div class="logo">True Talk X</div>
<div>
<button id="loginBtn">–í–æ–π—Ç–∏</button>
<button id="logoutBtn" class="outline" style="display:none">–í—ã–π—Ç–∏</button>
</div>
</header>
<main>
<div class="composer" id="composer" style="display:none">
<div class="avatar" id="meAvatar">?</div>
<textarea id="postText" placeholder="–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?" maxlength="280"></textarea>
<button id="sendPost">–ü–æ—Å—Ç</button>
</div>
<div id="feed"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { initializeFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, getDoc, setDoc, serverTimestamp, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyDOaDVzzPjyYm4HWMND2XYWjLy_h4wty5s",authDomain:"neuron-ecosystem-2025.firebaseapp.com",projectId:"neuron-ecosystem-2025",storageBucket:"neuron-ecosystem-2025.firebasestorage.app",messagingSenderId:"589834476565",appId:"1:589834476565:web:f657c13be1cbf8f3dd421c"};
const app=initializeApp(firebaseConfig);

// Long polling for restricted networks
const db = initializeFirestore(app,{experimentalForceLongPolling:true,useFetchStreams:false});

const auth=getAuth(app);

const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const composer=document.getElementById('composer');
const postText=document.getElementById('postText');
const sendPost=document.getElementById('sendPost');
const feed=document.getElementById('feed');
const meAvatar=document.getElementById('meAvatar');

let currentUser=null;

function randColor(){return ['#1d9bf0','#22c55e','#a855f7','#f97316','#e11d48'][Math.floor(Math.random()*5)]}

async function getProfile(uid){
 const ref=doc(db,'users',uid);
 const s=await getDoc(ref);
 if(s.exists()) return s.data();
 const data={nick:'anon'+uid.slice(0,4),color:randColor()};
 await setDoc(ref,data);
 return data;
}

loginBtn.onclick=()=>signInWithPopup(auth,new GoogleAuthProvider());
logoutBtn.onclick=()=>signOut(auth);

sendPost.onclick=async()=>{
 if(!postText.value.trim()) return;
 const u=await getProfile(currentUser.uid);
 await addDoc(collection(db,'posts'),{
  text:postText.value.trim(),
  authorId:currentUser.uid,
  authorNick:u.nick,
  authorColor:u.color,
  likes:[],
  likesCount:0,
  createdAt:serverTimestamp()
 });
 postText.value='';
}

onAuthStateChanged(auth,async user=>{
 currentUser=user;
 if(user){
  loginBtn.style.display='none';
  logoutBtn.style.display='inline-block';
  composer.style.display='flex';
  const u=await getProfile(user.uid);
  meAvatar.textContent=u.nick.slice(0,2).toUpperCase();
  meAvatar.style.background=u.color;
 }else{
  composer.style.display='none';
  loginBtn.style.display='inline-block';
  logoutBtn.style.display='none';
 }
});

onSnapshot(query(collection(db,'posts'),orderBy('createdAt','desc')),snap=>{
 feed.innerHTML='';
 snap.forEach(d=>renderPost(d.id,d.data()))
});

function renderPost(id,p){
 const root=document.createElement('div');
 root.className='post';

 const avatar=document.createElement('div');
 avatar.className='avatar';
 avatar.textContent=p.authorNick.slice(0,2).toUpperCase();
 avatar.style.background=p.authorColor;

 const body=document.createElement('div');
 body.className='post-body';

 const likeClass = p.likes?.includes(currentUser?.uid) ? 'like active':'like';

 body.innerHTML=`<div class='nick' style='color:${p.authorColor}'>${p.authorNick}</div>
 <div>${p.text}</div>
 <div class='actions'>
  <span class='${likeClass}' data-like="${id}">‚ù§ ${p.likesCount||0}</span>
  <span data-reply="${id}">üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å</span>
 </div>
 <div class='reply-box' style='display:none'>
  <textarea placeholder='–û—Ç–≤–µ—Ç...'></textarea>
  <button>‚Ü©</button>
 </div>
 <div class='replies'></div>`;

 body.querySelector('[data-like]').onclick=()=>toggleLike(id);

 const rToggle=body.querySelector('[data-reply]');
 const rBox=body.querySelector('.reply-box');
 rToggle.onclick=()=>rBox.style.display=rBox.style.display==='none'?'flex':'none';

 const sendReply=rBox.querySelector('button');
 sendReply.onclick=()=>sendReplyToPost(id,rBox);

 root.append(avatar,body);
 feed.appendChild(root);

 loadReplies(id, body.querySelector('.replies'));  
}

async function toggleLike(postId){
 if(!currentUser) return alert('–ù—É–∂–µ–Ω –≤—Ö–æ–¥');
 const ref=doc(db,'posts',postId);
 const p=await getDoc(ref);
 const likes=p.data().likes || [];
 const uid=currentUser.uid;
 if(likes.includes(uid)){
  await updateDoc(ref,{likes:arrayRemove(uid),likesCount:(p.data().likesCount||1)-1});
 }else{
  await updateDoc(ref,{likes:arrayUnion(uid),likesCount:(p.data().likesCount||0)+1});
 }
}

async function sendReplyToPost(postId,box){
 if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ');
 const ta=box.querySelector('textarea');
 if(!ta.value.trim())return;
 const u=await getProfile(currentUser.uid);
 await addDoc(collection(db,'posts',postId,'comments'),{
  text:ta.value.trim(),
  authorId:currentUser.uid,
  authorNick:u.nick,
  authorColor:u.color,
  createdAt:serverTimestamp()
 });
 ta.value='';
}

function loadReplies(postId,root){
 onSnapshot(query(collection(db,'posts',postId,'comments'),orderBy('createdAt','asc')),snap=>{
  root.innerHTML='';
  snap.forEach(d=>{
    const r=d.data();
    const div=document.createElement('div');
    div.className='reply';
    div.innerHTML=`<span style='color:${r.authorColor};font-weight:700'>${r.authorNick}</span><div>${r.text}</div>`;
    root.appendChild(div);
  })
 })
}
</script>
</body>
</html>
