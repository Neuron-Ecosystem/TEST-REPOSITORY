<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuron OS - Fixed</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>">
    <style>
        /* --- –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            -webkit-user-drag: none;
        }

        body {
            overflow: hidden;
            background: #000;
            color: #fff;
            height: 100vh;
            width: 100vw;
        }

        /* --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.5s ease;
        }

        .login-window {
            background: rgba(30, 30, 40, 0.9);
            border-radius: 20px;
            padding: 40px;
            width: 400px;
            max-width: 90vw;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            animation: scaleIn 0.5s ease;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-header p {
            color: #ccc;
            font-size: 1rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-size: 0.9rem;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
        }

        .login-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(78, 205, 196, 0.3);
        }

        .google-login-button {
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .google-login-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .register-link {
            text-align: center;
            color: #ccc;
        }

        .register-link a {
            color: #4ecdc4;
            text-decoration: none;
        }

        .register-link a:hover {
            text-decoration: underline;
        }

        .demo-button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
            z-index: 1001;
        }

        /* --- –†–∞–±–æ—á–∏–π —Å—Ç–æ–ª --- */
        .desktop {
            position: relative;
            width: 100%;
            height: 100vh;
            display: none;
        }

        /* 7. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –æ–±–æ–µ–≤ */
        .wallpaper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Default background set in JS: applyWallpaper('default') */
            z-index: -1;
            transition: background 0.5s ease;
        }

        /* –ò–∫–æ–Ω–∫–∏ —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞: 3. –°–¥–µ–ª–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ */
        .desktop-icons {
            position: absolute;
            top: 20px;
            left: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, 80px); /* Two columns for wide screens */
            gap: 20px;
        }

        .desktop-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            text-align: center;
        }

        .desktop-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .desktop-icon .icon {
            font-size: 2rem;
            margin-bottom: 5px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .desktop-icon span {
            font-size: 0.8rem;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        /* --- –ü–∞–Ω–µ–ª—å –∑–∞–¥–∞—á (Dock) --- */
        .dock {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(40, 40, 50, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 10px 20px;
            display: flex;
            gap: 15px;
            z-index: 999;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .dock-icon {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative; /* For indicator dot */
        }

        .dock-icon:hover {
            transform: translateY(-5px) scale(1.1);
            background: rgba(255, 255, 255, 0.1);
        }

        .dock-icon .app-icon {
            font-size: 1.5rem;
        }

        /* 8. –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–≤–µ—Ä–Ω—É—Ç–æ–≥–æ/–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ */
        .dock-icon::after {
            content: '';
            position: absolute;
            bottom: -8px; /* –ü–æ–∑–∏—Ü–∏—è —Ç–æ—á–∫–∏ */
            left: 50%;
            transform: translateX(-50%);
            width: 6px; /* –†–∞–∑–º–µ—Ä —Ç–æ—á–∫–∏ */
            height: 6px;
            background-color: #4ecdc4; /* –¶–≤–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .dock-icon.active::after,
        .dock-icon.minimized::after {
            opacity: 1; /* –¢–æ—á–∫–∞ –≤–∏–¥–Ω–∞, –∫–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–Ω–æ –∏–ª–∏ —Å–≤–µ—Ä–Ω—É—Ç–æ */
        }
        
        /* --- –û–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Window) --- */
        .window {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 600px;
            height: 400px;
            min-width: 300px;
            min-height: 200px;
            background: rgba(40, 40, 50, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            transform: translate(-50%, -50%) scale(1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s ease, top 0.3s ease, left 0.3s ease, width 0.3s ease, height 0.3s ease, border-radius 0.3s ease;
            animation: windowOpen 0.3s ease;
            z-index: 10;
        }

        .window.minimized {
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            pointer-events: none;
        }

        /* 6. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        .window.maximized {
            width: 100vw !important;
            height: 100vh !important;
            top: 0 !important;
            left: 0 !important;
            transform: none !important;
            border-radius: 0 !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
        }

        .window-title-bar {
            cursor: grab;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .window.maximized .window-title-bar {
            border-radius: 0;
        }

        .window-title-bar .title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .window-controls {
            display: flex;
            gap: 8px;
        }

        .window-controls button {
            width: 18px;
            height: 18px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            color: black;
            font-weight: bold;
            transition: all 0.1s ease;
        }

        .window-controls .close-btn { background: #ff5f56; }
        .window-controls .minimize-btn { background: #ffbd2e; }
        .window-controls .maximize-btn { background: #27c93f; }

        .window-controls button:hover {
            opacity: 0.7;
        }
        
        .window-content {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
        }

        /* --- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (Right-Click) --- */
        .context-menu {
            position: fixed;
            background: rgba(50, 50, 60, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            padding: 5px 0;
            min-width: 200px;
            /* 3. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–Ω—é */
            max-height: 90vh;
            overflow-y: auto;
        }

        .context-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 0.9rem;
        }

        .context-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (Settings) --- */
        .settings-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .settings-group h3 {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: #4ecdc4;
        }
        
        .wallpaper-preview-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .wallpaper-preview {
            border: 3px solid transparent;
            transition: border-color 0.3s ease;
        }
        
        .wallpaper-preview.selected {
            border-color: #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }
        
        .logout-button {
            width: 100%;
            padding: 12px;
            background: #ff6b6b;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }
        
        .logout-button:hover {
            background: #e65c5c;
        }

        /* --- –ê–Ω–∏–º–∞—Ü–∏–∏ --- */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes windowOpen {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .desktop-icons { top: 10px; left: 10px; gap: 15px; }
            .desktop-icon { width: 60px; }
            .desktop-icon .icon { font-size: 1.5rem; }
            .desktop-icon span { font-size: 0.7rem; }
            .dock { bottom: 10px; padding: 8px 15px; }
            .dock-icon { font-size: 1.5rem; }
            .window { width: 95vw; height: 70vh; }
        }
    </style>
</head>
<body>

    <div class="modal" id="login-modal">
        <div class="login-window">
            <div class="login-header">
                <h2>üß† Neuron OS</h2>
                <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å. –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞.</p>
            </div>
            <form onsubmit="handleLogin(); return false;">
                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required placeholder="name@example.com">
                </div>
                <div class="input-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" id="login-btn" class="login-button">–í–æ–π—Ç–∏</button>
            </form>
            <button class="google-login-button" onclick="handleGoogleLogin()">
                –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
            </button>
            <div class="register-link">
                <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: –≤–≤–µ–¥–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π email –∏ –ø–∞—Ä–æ–ª—å –∏ –Ω–∞–∂–º–∏—Ç–µ –í–æ–π—Ç–∏');">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
            </div>
        </div>
    </div>
    
    <button class="demo-button" onclick="activateDemoMode()">–î–µ–º–æ-–≤—Ö–æ–¥</button>

    <div class="desktop" id="desktop">
        <div class="wallpaper" id="wallpaper"></div>

        <div class="desktop-icons" id="desktop-icons">
            <div class="desktop-icon" data-app="ai" onclick="openApp('ai')">
                <div class="icon">ü§ñ</div> <span>Neuron AI</span>
            </div>
            <div class="desktop-icon" data-app="notes" onclick="openApp('notes')">
                <div class="icon">üìù</div> <span>Notes</span>
            </div>
            <div class="desktop-icon" data-app="converter" onclick="openApp('converter')">
                <div class="icon">üîÑ</div> <span>Converter</span>
            </div>
            <div class="desktop-icon" data-app="budget" onclick="openApp('budget')">
                <div class="icon">üí∞</div> <span>Budget</span>
            </div>
            <div class="desktop-icon" data-app="settings" onclick="openApp('settings')">
                <div class="icon">‚öôÔ∏è</div> <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </div>
            </div>
    </div>

    <div class="dock">
        <div id="dock-icons" class="dock-icons">
            </div>
    </div>

    <div class="context-menu" id="context-menu">
        <div class="context-item" onclick="openApp(document.getElementById('context-menu').dataset.targetApp)">–û—Ç–∫—Ä—ã—Ç—å</div>
        <div class="context-item" id="context-pin" onclick="handleContextMenuAction('pin')">–ó–∞–∫—Ä–µ–ø–∏—Ç—å –Ω–∞ –ø–∞–Ω–µ–ª–∏ –∑–∞–¥–∞—á</div>
        <div class="context-item" id="context-unpin" onclick="handleContextMenuAction('unpin')" style="display: none;">–û—Ç–∫—Ä–µ–ø–∏—Ç—å –æ—Ç –ø–∞–Ω–µ–ª–∏ –∑–∞–¥–∞—á</div>
        <div class="context-item" onclick="handleContextMenuAction('ask-ai')">–°–ø—Ä–æ—Å–∏—Ç—å –æ–± —ç—Ç–æ–º —É AI</div>
        <div class="context-item" onclick="closeApp(document.getElementById('context-menu').dataset.targetApp)">–ó–∞–∫—Ä—ã—Ç—å</div>
    </div>

    <script>
        // --- –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---
        const state = {
            currentUser: null,
            users: {
                'demo@user.com': { password: 'password', uid: 'demo_123' }
            },
            openWindows: {}, // { appId: windowElement }
            dockApps: ['ai', 'settings', 'notes'], // Apps that are permanently pinned
            maxZIndex: 10,
            userData: {}, // For storing dock/wallpaper preference
        };

        const apps = {
            'ai': { name: 'Neuron AI', icon: 'ü§ñ', content: '<h2>Neuron AI</h2><p>–í–∞—à –ª–∏—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º.</p><p><input type="text" id="ai-input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..." style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 5px; border: none; background: rgba(255,255,255,0.1); color: white;"></p>' },
            'settings': { name: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', icon: '‚öôÔ∏è', content: `
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <div class="settings-content">
                    <div class="settings-group">
                        <h3>–û–±–æ–∏</h3>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞.</p>
                        <div class="wallpaper-preview-container" id="wallpaper-selector">
                            <div class="wallpaper-preview selected" data-wallpaper="default" style="width: 120px; height: 80px; background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%); border-radius: 10px; cursor: pointer;" onclick="selectWallpaper('default', this)"></div>
                            <div class="wallpaper-preview" data-wallpaper="abstract" style="width: 120px; height: 80px; background: linear-gradient(135deg, #0d324d 0%, #7f5a83 100%); border-radius: 10px; cursor: pointer;" onclick="selectWallpaper('abstract', this)"></div>
                            <div class="wallpaper-preview" data-wallpaper="nature" style="width: 120px; height: 80px; background: linear-gradient(135deg, #134E5E 0%, #71B280 100%); border-radius: 10px; cursor: pointer;" onclick="selectWallpaper('nature', this)"></div>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>–ê–∫–∫–∞—É–Ω—Ç</h3>
                        <button class="logout-button" onclick="logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
                    </div>
                </div>
            `},
            'notes': { name: 'Notes', icon: 'üìù', content: '<h2>–ó–∞–º–µ—Ç–∫–∏</h2><textarea style="width: 100%; height: 250px; padding: 10px; background: rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.1); border-radius: 5px; color: white;">–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å —Å–≤–æ—é –∑–∞–º–µ—Ç–∫—É –∑–¥–µ—Å—å...</textarea>' },
            'converter': { name: 'Converter', icon: 'üîÑ', content: '<h2>Neuron Converter</h2><p>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç –∏ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è.</p>' },
            'budget': { name: 'Neuron Budget', icon: 'üí∞', content: '<h2>Neuron Budget</h2><p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤.</p>' },
        };

        // --- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---

        function checkLoginState() {
            const user = localStorage.getItem('neuron_current_user');
            if (user) {
                state.currentUser = JSON.parse(user);
                showDesktop();
            } else {
                document.getElementById('login-modal').style.display = 'flex';
                document.getElementById('desktop').style.display = 'none';
            }
        }

        // 1. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–õ–æ–≥–∏–Ω)
        function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('login-btn');
            loginBtn.textContent = '–í—Ö–æ–¥...';
            loginBtn.disabled = true;

            // –õ–æ–∫–∞–ª—å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–¥–ª—è –¥–µ–º–æ)
            setTimeout(() => {
                const user = state.users[email];
                if (user && user.password === password) {
                    state.currentUser = { email, uid: user.uid };
                    localStorage.setItem('neuron_current_user', JSON.stringify(state.currentUser));
                    showDesktop();
                } else if (email === 'demo@user.com' && password === 'password') {
                    // Fallback for easy demo
                    state.currentUser = { email, uid: 'demo_123' };
                    localStorage.setItem('neuron_current_user', JSON.stringify(state.currentUser));
                    showDesktop();
                } else {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å. (–î–ª—è –¥–µ–º–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: demo@user.com/password)');
                }
                loginBtn.textContent = '–í–æ–π—Ç–∏';
                loginBtn.disabled = false;
            }, 1000);
        }
        
        // 1. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Google - Mock)
        function handleGoogleLogin() {
            console.log('Google login initiated (mock)');
            // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Firebase Auth (Google Provider)
            // –î–ª—è —Ü–µ–ª–µ–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏, –∏–º–∏—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
            setTimeout(() => {
                state.currentUser = { email: 'google_user@os.com', uid: 'google_mock_uid', name: 'Google User' };
                localStorage.setItem('neuron_current_user', JSON.stringify(state.currentUser));
                showDesktop();
            }, 1000);
        }

        function activateDemoMode() {
            state.currentUser = { email: 'demo@os.com', uid: 'demo_mode', name: 'Demo User' };
            localStorage.setItem('neuron_current_user', JSON.stringify(state.currentUser));
            showDesktop();
        }

        // 2. –§—É–Ω–∫—Ü–∏—è –í—ã–π—Ç–∏
        function logout() {
            state.currentUser = null;
            localStorage.removeItem('neuron_current_user');
            
            // –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ–∫–Ω–∞
            Object.keys(state.openWindows).forEach(appId => {
                state.openWindows[appId].remove();
                delete state.openWindows[appId];
            });
            
            // –û—á–∏—Å—Ç–∏—Ç—å Dock (–∫—Ä–æ–º–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–∑–∂–µ)
            state.dockApps = ['ai', 'settings', 'notes']; // —Å–±—Ä–æ—Å –¥–æ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            initializeDock();
            saveUserData();
            
            document.getElementById('login-modal').style.display = 'flex';
            document.getElementById('desktop').style.display = 'none';
            // –û–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥ –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞
            document.getElementById('login-btn').textContent = '–í–æ–π—Ç–∏';
            document.getElementById('login-btn').disabled = false;
        }

        function showDesktop() {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('desktop').style.display = 'block';
            loadUserData();
        }

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏ –∏ –æ–∫–Ω–∞–º–∏ ---

        function updateZIndices() {
            let z = 10;
            const windows = document.querySelectorAll('.window');
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º z-index –¥–ª—è –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –æ–∫–æ–Ω
            windows.forEach(win => {
                if (win.dataset.appId in state.openWindows) {
                    win.style.zIndex = state.openWindows[win.dataset.appId].style.zIndex;
                }
            });
            // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π z-index
            state.maxZIndex = Math.max(10, ...Array.from(windows).map(w => parseInt(w.style.zIndex) || 10));
        }

        function bringWindowToFront(appId) {
            if (state.openWindows[appId]) {
                state.maxZIndex++;
                state.openWindows[appId].style.zIndex = state.maxZIndex;
            }
        }

        // 5. –û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function openApp(appId) {
            if (!apps[appId]) {
                alert('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!');
                return;
            }
            
            // –ï—Å–ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ –ø–µ—Ä–µ–Ω–æ—Å–∏–º –Ω–∞ –ø–µ—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω
            if (state.openWindows[appId]) {
                const windowEl = state.openWindows[appId];
                windowEl.classList.remove('minimized'); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–∫–Ω–æ
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã Dock Icon
                const dockIcon = document.querySelector(`.dock-icon[data-app="${appId}"]`);
                if (dockIcon) {
                    dockIcon.classList.add('active');
                    dockIcon.classList.remove('minimized');
                }

                bringWindowToFront(appId);
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –æ–∫–Ω–æ
            createAppWindow(appId);

            // 5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–æ–π –≤ Dock: –¥–æ–±–∞–≤–ª—è–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ
            let isPinned = state.dockApps.includes(appId);

            if (!isPinned) {
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ, –µ—Å–ª–∏ –Ω–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ (–Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ state.dockApps)
                if (!document.querySelector(`.dock-icon[data-app="${appId}"]`)) {
                    addAppToDock(appId, true); // true = temporary
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            updateActiveIndicator(appId, true);
        }
        
        function closeApp(appId) {
            const windowEl = state.openWindows[appId];
            if (windowEl) {
                windowEl.remove();
                delete state.openWindows[appId];

                // 5. –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–∫–æ–Ω–∫–∏ –∏–∑ Dock
                const dockIcon = document.querySelector(`.dock-icon[data-app="${appId}"]`);
                if (dockIcon) {
                    let isPinned = state.dockApps.includes(appId);
                    
                    if (!isPinned) {
                        dockIcon.remove(); // –£–¥–∞–ª—è–µ–º, –µ—Å–ª–∏ –Ω–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ
                    } else {
                        updateActiveIndicator(appId, false); // –ï—Å–ª–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ, –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    }
                }
                
                updateZIndices();
            }
        }

        // 8. –°–≤–µ—Ä–Ω—É—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        function minimizeApp(appId) {
            const windowEl = state.openWindows[appId];
            if (windowEl) {
                windowEl.classList.add('minimized');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å 'minimized' –¥–ª—è –∏–∫–æ–Ω–∫–∏ –≤ Dock, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–∫—É
                const dockIcon = document.querySelector(`.dock-icon[data-app="${appId}"]`);
                if (dockIcon) {
                    dockIcon.classList.remove('active');
                    dockIcon.classList.add('minimized');
                }
            }
        }

        // 6. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        function maximizeApp(appId) {
            const windowEl = state.openWindows[appId];
            if (windowEl) {
                windowEl.classList.toggle('maximized');
                // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É –∫–Ω–æ–ø–∫–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å
                const maximizeBtn = windowEl.querySelector('.window-controls .maximize-btn');
                if (windowEl.classList.contains('maximized')) {
                    maximizeBtn.innerHTML = '‚ùê'; // –ò–∫–æ–Ω–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                    windowEl.style.top = '0px'; // –§–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ
                    windowEl.style.left = '0px';
                } else {
                    maximizeBtn.innerHTML = '‚ñ¢'; // –ò–∫–æ–Ω–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å)
                    windowEl.style.top = '50%';
                    windowEl.style.left = '50%';
                }
                bringWindowToFront(appId);
            }
        }

        function toggleAppWindow(appId) {
            if (state.openWindows[appId]) {
                const windowEl = state.openWindows[appId];
                if (windowEl.classList.contains('minimized')) {
                    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    windowEl.classList.remove('minimized');
                    bringWindowToFront(appId);
                    updateActiveIndicator(appId, true); // –°–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–µ–Ω
                    
                    const dockIcon = document.querySelector(`.dock-icon[data-app="${appId}"]`);
                    if (dockIcon) dockIcon.classList.remove('minimized');

                } else {
                    // –°–≤–µ—Ä–Ω—É—Ç—å
                    minimizeApp(appId);
                }
            } else {
                // –û—Ç–∫—Ä—ã—Ç—å
                openApp(appId);
            }
        }

        function createAppWindow(appId) {
            const app = apps[appId];
            const desktop = document.getElementById('desktop');
            const windowEl = document.createElement('div');
            windowEl.className = 'window';
            windowEl.dataset.appId = appId;
            windowEl.style.zIndex = ++state.maxZIndex;
            windowEl.style.left = `${50 + Math.floor(Math.random() * 10 - 5)}%`; // –°–º–µ—â–µ–Ω–∏–µ –¥–ª—è –∫–∞—Å–∫–∞–¥–∞
            windowEl.style.top = `${50 + Math.floor(Math.random() * 10 - 5)}%`;

            windowEl.innerHTML = `
                <div class="window-title-bar">
                    <div class="title">${app.icon} ${app.name}</div>
                    <div class="window-controls">
                        <button class="minimize-btn" onclick="minimizeApp('${appId}')">‚Äì</button>
                        <button class="maximize-btn" onclick="maximizeApp('${appId}')">‚ñ¢</button>
                        <button class="close-btn" onclick="closeApp('${appId}')">√ó</button>
                    </div>
                </div>
                <div class="window-content">${app.content}</div>
            `;
            
            desktop.appendChild(windowEl);
            state.openWindows[appId] = windowEl;

            // –°–¥–µ–ª–∞—Ç—å –æ–∫–Ω–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º
            makeDraggable(windowEl);
            
            // –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ –ø–µ—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω –ø–æ –∫–ª–∏–∫—É
            windowEl.addEventListener('mousedown', () => bringWindowToFront(appId));
        }
        
        function makeDraggable(windowEl) {
            const titleBar = windowEl.querySelector('.window-title-bar');
            let isDragging = false;
            let offset = { x: 0, y: 0 };

            titleBar.onmousedown = (e) => {
                // –ù–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                if (e.target.closest('.window-controls')) return;
                
                isDragging = true;
                bringWindowToFront(windowEl.dataset.appId);
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø–∏–∫—Å–µ–ª–∏
                const rect = windowEl.getBoundingClientRect();
                const style = window.getComputedStyle(windowEl);
                let currentX = parseFloat(style.left);
                let currentY = parseFloat(style.top);
                
                // –ï—Å–ª–∏ –Ω–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ, –Ω–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å
                if (!windowEl.classList.contains('maximized')) {
                    offset.x = e.clientX - rect.left;
                    offset.y = e.clientY - rect.top;
                    titleBar.style.cursor = 'grabbing';
                }
            };

            document.onmouseup = () => {
                isDragging = false;
                titleBar.style.cursor = 'grab';
            };

            document.onmousemove = (e) => {
                if (!isDragging || windowEl.classList.contains('maximized')) return;
                
                let newX = e.clientX - offset.x;
                let newY = e.clientY - offset.y;
                
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü (–ø—Ä–æ—Å—Ç–æ–µ)
                const desktopRect = document.getElementById('desktop').getBoundingClientRect();
                const windowRect = windowEl.getBoundingClientRect();

                newX = Math.max(desktopRect.left, newX);
                newY = Math.max(desktopRect.top, newY);
                newX = Math.min(desktopRect.right - windowRect.width, newX);
                newY = Math.min(desktopRect.bottom - windowRect.height, newY);
                
                windowEl.style.left = newX + 'px';
                windowEl.style.top = newY + 'px';
            };
        }

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Dock ---
        
        function addAppToDock(appId, isTemporary = false) {
            const dock = document.getElementById('dock-icons');
            const app = apps[appId];
            
            let dockIcon = document.querySelector(`.dock-icon[data-app="${appId}"]`);
            if (dockIcon) return;

            dockIcon = document.createElement('div');
            dockIcon.className = 'dock-icon';
            dockIcon.dataset.app = appId;
            dockIcon.innerHTML = `<div class="app-icon">${app.icon}</div>`;
            dockIcon.setAttribute('title', app.name);

            dockIcon.onclick = () => toggleAppWindow(appId);
            
            // 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É—à–∞—Ç–µ–ª—è –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–∏ –º—ã—à–∏
            addDockContextMenuListener(dockIcon, appId);
            
            dock.appendChild(dockIcon);
        }
        
        // 5. & 8. –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        function updateActiveIndicator(appId, isActive) {
            const dockIcon = document.querySelector(`.dock-icon[data-app="${appId}"]`);
            if (dockIcon) {
                if (isActive) {
                    dockIcon.classList.add('active');
                    dockIcon.classList.remove('minimized');
                } else {
                    // –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ
                    dockIcon.classList.remove('active');
                    dockIcon.classList.remove('minimized');
                    
                    // 5. –ï—Å–ª–∏ –∏–∫–æ–Ω–∫–∞ –Ω–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞, –µ–µ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                    if (!state.dockApps.includes(appId)) {
                        dockIcon.remove();
                    }
                }
            }
        }

        function initializeDock() {
            const dock = document.getElementById('dock-icons');
            dock.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞
            state.dockApps.forEach(appId => {
                addAppToDock(appId);
            });
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ –Ω–∞ —Ä–∞–±–æ—á–µ–º —Å—Ç–æ–ª–µ
            document.querySelectorAll('.desktop-icon').forEach(icon => {
                icon.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(e, e.currentTarget.dataset.app, false); // false = desktop
                });
            });
        }
        
        // 4. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –¥–ª—è Dock
        function addDockContextMenuListener(dockIcon, appId) {
            dockIcon.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                const isPinned = state.dockApps.includes(appId);
                
                if (isPinned) {
                    showContextMenu(e, appId, true); // true = dock
                } else {
                    // –î–ª—è –Ω–µ–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–≥–æ, –Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –º–µ–Ω—é
                    // –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ, –Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø—Ü–∏–∏
                    showContextMenu(e, appId, false, true); // isDock=false, isOpenButNotPinned=true
                }
            });
        }


        // --- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ---
        
        // 3. & 4. –ü–æ–∫–∞–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
        function showContextMenu(e, appId, isDock = false, isOpenButNotPinned = false) {
            e.preventDefault();
            const contextMenu = document.getElementById('context-menu');
            const desktopPinOption = document.getElementById('context-pin');
            const dockUnpinOption = document.getElementById('context-unpin');
            const isPinned = state.dockApps.includes(appId);

            // 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø—Ü–∏–π "–ó–∞–∫—Ä–µ–ø–∏—Ç—å/–û—Ç–∫—Ä–µ–ø–∏—Ç—å"
            if (isDock || isPinned) {
                // –ï—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–π –∏–∫–æ–Ω–∫–µ –≤ Dock
                desktopPinOption.style.display = 'none';
                dockUnpinOption.style.display = 'block';
            } else if (isOpenButNotPinned) {
                 // –ï—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–∫–æ–Ω–∫–µ (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ, –Ω–æ –Ω–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ)
                desktopPinOption.style.display = 'block'; // –ú–æ–∂–Ω–æ –∑–∞–∫—Ä–µ–ø–∏—Ç—å
                dockUnpinOption.style.display = 'none';
            } else {
                // –ï—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ –∏–∫–æ–Ω–∫–µ –Ω–∞ —Ä–∞–±–æ—á–µ–º —Å—Ç–æ–ª–µ
                desktopPinOption.style.display = isPinned ? 'none' : 'block';
                dockUnpinOption.style.display = 'none';
            }

            contextMenu.dataset.targetApp = appId;
            contextMenu.style.display = 'block';

            let x = e.clientX;
            let y = e.clientY;

            // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü —ç–∫—Ä–∞–Ω–∞
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const menuWidth = contextMenu.offsetWidth;
            const menuHeight = contextMenu.offsetHeight;

            if (x + menuWidth > viewportWidth) {
                x = viewportWidth - menuWidth - 5;
            }
            if (y + menuHeight > viewportHeight) {
                y = viewportHeight - menuHeight - 5;
            }

            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;
        }

        function hideContextMenu() {
            document.getElementById('context-menu').style.display = 'none';
        }

        function handleContextMenuAction(action) {
            const contextMenu = document.getElementById('context-menu');
            const appId = contextMenu.dataset.targetApp;
            const app = apps[appId];
            
            switch(action) {
                case 'pin':
                    if (!state.dockApps.includes(appId)) {
                        state.dockApps.push(appId);
                        // –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç–æ, –µ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –∏–∫–æ–Ω–∫–∞ —Å—Ç–∞–Ω–µ—Ç –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–π
                        let dockIcon = document.querySelector(`.dock-icon[data-app="${appId}"]`);
                        if (!dockIcon) {
                           addAppToDock(appId);
                        } else {
                            // –ï—Å–ª–∏ –∏–∫–æ–Ω–∫–∞ —É–∂–µ –µ—Å—Ç—å (–∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω–∞—è), –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ—á–∞–µ–º –µ–µ –∫–∞–∫ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—É—é –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                        }
                        saveUserData();
                    }
                    break;
                case 'unpin': // 4. –û—Ç–∫—Ä–µ–ø–∏—Ç—å –æ—Ç –ø–∞–Ω–µ–ª–∏ –∑–∞–¥–∞—á
                    state.dockApps = state.dockApps.filter(id => id !== appId);
                    saveUserData();
                    
                    // –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–æ, —É–¥–∞–ª—è–µ–º –∏–∫–æ–Ω–∫—É —Å—Ä–∞–∑—É
                    if (!state.openWindows[appId]) {
                        document.querySelector(`.dock-icon[data-app="${appId}"]`).remove();
                    } else {
                        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ, –∏–∫–æ–Ω–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω–∞—è (–ø–æ–∫–∞ –Ω–µ –∑–∞–∫—Ä–æ—é—Ç)
                        updateActiveIndicator(appId, true); // –û–±–Ω–æ–≤–∏—Ç—å, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ç—É—Å pinned
                    }
                    break;
                case 'ask-ai':
                    openApp('ai');
                    setTimeout(() => {
                        const aiInput = document.getElementById('ai-input');
                        if (aiInput) {
                            aiInput.value = `–†–∞—Å—Å–∫–∞–∂–∏ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ "${app.name}"`;
                        }
                    }, 100);
                    break;
                // 'open' –∏ 'close' –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ onclick –∞—Ç—Ä–∏–±—É—Ç–∞—Ö
            }
            hideContextMenu();
        }

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—è–º–∏ ---
        
        // 7. & 9. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–±–æ–µ–≤
        function applyWallpaper(wallpaper) {
            const wallpaperEl = document.getElementById('wallpaper');
            
            // –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π
            wallpaperEl.style.backgroundImage = 'none';
            wallpaperEl.style.backgroundColor = 'transparent';
            wallpaperEl.style.backgroundSize = 'auto';
            wallpaperEl.style.backgroundPosition = 'top left';

            if (wallpaper === 'default') {
                // 7. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ–±–æ–∏ (—Ç–µ–º–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç)
                wallpaperEl.style.background = 'linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%)';
            } else if (wallpaper === 'abstract') {
                wallpaperEl.style.background = 'linear-gradient(135deg, #0d324d 0%, #7f5a83 100%)';
            } else if (wallpaper === 'nature') {
                wallpaperEl.style.background = 'linear-gradient(135deg, #134E5E 0%, #71B280 100%)';
            } else if (wallpaper === 'city') {
                wallpaperEl.style.background = 'linear-gradient(135deg, #2C3E50 0%, #4CA1AF 100%)';
            }
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
            state.userData.wallpaper = wallpaper;
            saveUserData();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞
            document.querySelectorAll('.wallpaper-preview').forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.wallpaper === wallpaper) {
                    el.classList.add('selected');
                }
            });
        }
        
        function selectWallpaper(wallpaper, element) {
            applyWallpaper(wallpaper);
        }

        // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---

        function loadUserData() {
            const savedData = localStorage.getItem('neuron_user_data');
            if (savedData) {
                state.userData = JSON.parse(savedData);
                applyUserPreferences();
            } else {
                // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                applyWallpaper('default');
                initializeDock();
            }
        }

        function saveUserData() {
            localStorage.setItem('neuron_user_data', JSON.stringify({
                dockApps: state.dockApps,
                wallpaper: state.userData.wallpaper || 'default',
                lastUpdated: new Date()
            }));
        }

        function applyUserPreferences() {
            if (state.userData.dockApps) {
                state.dockApps = state.userData.dockApps;
            }
            if (state.userData.wallpaper) {
                applyWallpaper(state.userData.wallpaper);
            }
            initializeDock();
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginState();
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Dock –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ª–æ–≥–∏–Ω–∞/–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –¥–ª—è —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞
            document.getElementById('desktop').addEventListener('contextmenu', (e) => {
                if (e.target.id === 'desktop' || e.target.classList.contains('wallpaper')) {
                    e.preventDefault();
                    // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞, –Ω–æ –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º
                    hideContextMenu();
                }
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø–æ –∫–ª–∏–∫—É
            document.addEventListener('click', hideContextMenu);
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.openApp = openApp;
        window.handleLogin = handleLogin;
        window.handleGoogleLogin = handleGoogleLogin;
        window.logout = logout; // –î–æ–±–∞–≤–ª–µ–Ω–æ
        window.handleContextMenuAction = handleContextMenuAction;
        window.closeApp = closeApp;
        window.minimizeApp = minimizeApp;
        window.maximizeApp = maximizeApp;
        window.selectWallpaper = selectWallpaper;
        window.applyWallpaper = applyWallpaper;
        window.activateDemoMode = activateDemoMode;

    </script>
</body>
</html>
